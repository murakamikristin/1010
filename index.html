<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<meta name="theme-color" content="#F5F1ED" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="default" />
<link rel="manifest" href="manifest.webmanifest" />
<link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png" />
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Amiko:wght@400;600&display=swap" rel="stylesheet" />
<title>1010 â€” Minimal</title>

<style>
  :root{
    font-family:'SF Pro Display','SF Pro Text','SF Pro','-apple-system',BlinkMacSystemFont,'Segoe UI',system-ui,sans-serif;
    --bg:#F5F1ED;
    --surface:#FFFFFF;
    --board:var(--bg);
    --tile:#FFFFFF;
    --tile-border:#E8E0D7;
    --text:#243042;
    --muted:#818181;
    --icon:#243042;
    --button-bg:#243042;
    --button-text:#F5F1ED;
    --panel-bg:#FFFFFF;
    --panel-border:rgba(36,48,66,.08);
    --panel-handle:#E4DBD1;
    --overlay:rgba(7,8,15,.28);
    --shadow:0 24px 70px rgba(17,20,30,.14);
    --settings-surface:#FFFFFF;
    --settings-border:rgba(36,48,66,.08);
    --settings-shadow:0 24px 60px rgba(17,20,30,.16);
    --segmented-track:#F5F1ED;
    --segment-active-bg:#243042;
    --segment-active-text:#F5F1ED;
    --block:#8FA9BC;
    --max-width:620px;
    --board-size:620px;
    --cell-radius:7px;
    --pip-radius:5px;
    --grid-gap:3px;
    --tray-slot-height:150px;
    --stack-gap:clamp(18px,5vw,32px);
    --transition-fast:.28s;
    --accent:#243042;
    --toggle-thumb:#FFFFFF;
    --toggle-bg:#F5F1ED;
    --sf-icon-crown:url('data:image/png;base64,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');
    --sf-icon-palette:url('data:image/png;base64,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');
  }
  :root[data-theme="dark"]{
    --bg:#243042;
    --surface:#2D3B53;
    --board:var(--bg);
    --tile:#2D3B53;
    --tile-border:rgba(245,241,237,.14);
    --text:#F5F1ED;
    --muted:#818181;
    --icon:#F5F1ED;
    --button-bg:#F5F1ED;
    --button-text:#243042;
    --panel-bg:#2D3B53;
    --panel-border:rgba(245,241,237,.16);
    --panel-handle:#2D3B53;
    --overlay:rgba(5,7,12,.55);
    --shadow:0 30px 70px rgba(3,7,15,.65);
    --settings-surface:#2D3B53;
    --settings-border:rgba(245,241,237,.16);
    --settings-shadow:0 30px 80px rgba(3,7,15,.72);
    --segmented-track:#2D3B53;
    --segment-active-bg:#F5F1ED;
    --segment-active-text:#243042;
    --block:#8FA9BC;
    --accent:#F5F1ED;
    --toggle-thumb:#243042;
    --toggle-bg:#2D3B53;
  }
  *,*::before,*::after{box-sizing:border-box;}
  html, body{
    overflow:hidden;
    overscroll-behavior:none;
  }
  body{
    margin:0;
    min-height:100vh;
    background:var(--bg);
    color:var(--text);
    font-family:inherit;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:var(--stack-gap);
    padding:calc(env(safe-area-inset-top, 16px) + clamp(10px,2.5vw,18px)) clamp(12px,4vw,24px) clamp(24px,5vw,42px);
    transition:background .35s ease,color .35s ease;
    -webkit-user-select:none;
    user-select:none;
    -webkit-touch-callout:none;
    touch-action:none;
  }
  button,
  input,
  select,
  textarea{font:inherit;}
  button{background:none;border:none;padding:0;color:inherit;}
  .topbar{
    width:100%;
    max-width:var(--max-width);
    display:flex;
    flex-direction:column;
    align-items:stretch;
    gap:clamp(14px,3vw,24px);
    transition:opacity var(--transition-fast) ease;
  }
  .controls-row{
    display:flex;
    justify-content:flex-end;
    align-items:center;
    gap:14px;
    padding-top:clamp(12px,3vw,22px);
  }
  .topbar.minimal{opacity:0;pointer-events:none;}
  .score-stack{display:flex;flex-direction:column;gap:10px;align-items:flex-start;padding-top:clamp(18px,4vw,32px);}
  .score-value{
    font-size:clamp(28px,7vw,32px);
    font-weight:400;
    letter-spacing:.01em;
    font-variant-numeric:tabular-nums;
    color:var(--text);
    font-family:'SF Mono','SFMono-Regular','Menlo',monospace;
  }
  .best-row{display:flex;align-items:center;gap:8px;color:var(--muted);font-size:clamp(16px,4vw,18px);line-height:1.2;}
  .best-row .crown-icon{color:var(--muted);width:30px;height:24px;}
  .best-value{
    font-weight:400;
    font-variant-numeric:tabular-nums;
    letter-spacing:.06em;
    color:var(--muted);
    font-family:'SF Mono','SFMono-Regular','Menlo',monospace;
    line-height:1;
    position:relative;
    top:2px;
  }
  .icon-btn{
    width:auto;
    height:auto;
    border:none;
    background:transparent;
    display:flex;
    align-items:center;
    justify-content:center;
    color:var(--icon);
    cursor:pointer;
    padding:4px;
  }
  .icon-btn:active{transform:scale(.95);}
  .icon-btn svg{width:28px;height:28px;stroke:currentColor;stroke-linecap:round;stroke-linejoin:round;}
  .sf-icon{display:inline-flex;width:30px;height:30px;background-color:currentColor;-webkit-mask-repeat:no-repeat;-webkit-mask-position:center;-webkit-mask-size:contain;mask-repeat:no-repeat;mask-position:center;mask-size:contain;}
  .crown-icon{-webkit-mask-image:var(--sf-icon-crown);mask-image:var(--sf-icon-crown);width:30px;height:24px;}
  .palette-icon{-webkit-mask-image:var(--sf-icon-palette);mask-image:var(--sf-icon-palette);}
  .wrap{width:100%;max-width:var(--max-width);display:flex;flex-direction:column;align-items:center;gap:clamp(16px,4vw,26px);margin-top:clamp(6px,2vw,14px);}
  .board{
    width:min(100%, var(--board-size));
    max-width:var(--max-width);
    aspect-ratio:1/1;
    background:var(--bg);
    border:none;
    padding:calc(var(--grid-gap) * 0.6);
    display:grid;
    grid-template-columns:repeat(10,1fr);
    grid-template-rows:repeat(10,1fr);
    gap:var(--grid-gap);
  }
  .board.dragging{opacity:1;}
  .cell{
    position:relative;
    border-radius:var(--cell-radius);
    background:var(--tile);
    border:none;
    transition:background .18s ease, transform .16s ease, opacity .12s ease;
    box-shadow:none;
  }
  .cell.filled{
    border-color:transparent;
    box-shadow:none;
    background:var(--cell-fill, var(--block));
    transform:scale(.96);
  }
  .cell.filled.animating-in{
    transform:scale(1);
    transition:transform .16s ease, background .18s ease;
  }
  .cell.preview{box-shadow:none;}
  .cell.clearing{animation:clearSentinel .45s ease forwards;animation-delay:var(--clear-delay, 0s);}
  .cell.clearing::after{content:'';position:absolute;inset:0;border-radius:inherit;background:var(--clear-color, var(--block));animation:cascadeClear .45s cubic-bezier(.26,.01,.24,1);animation-delay:var(--clear-delay, 0s);}
  @keyframes clearSentinel{0%{opacity:1;}100%{opacity:1;}}
  @keyframes cascadeClear{
    0%{transform:translateY(0) scale(1);opacity:1;}
    25%{transform:translateY(-4px) scale(.98);opacity:.9;}
    60%{transform:translateY(-14px) scale(.82);opacity:.6;}
    100%{transform:translateY(-20px) scale(.7);opacity:0;}
  }
  .tray{
    width:min(100%, var(--board-size));
    max-width:var(--max-width);
    display:flex;
    gap:clamp(12px,3vw,24px);
    align-items:stretch;
  }
  .piece{
    flex:1 1 0;
    min-width:0;
    min-height:var(--tray-slot-height);
    height:var(--tray-slot-height);
    border-radius:22px;
    padding:0;
    border:none;
    background:transparent;
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:grab;
    touch-action:none;
    position:relative;
  }
  .piece:active{cursor:grabbing;}
  .piece.empty{visibility:hidden;pointer-events:none;}
  .piece.dragging{opacity:0;pointer-events:none;}
  .piece-overlay{position:absolute;top:50%;left:50%;transform:translate(-50%, -50%);pointer-events:none;}
  .piece-inner{display:grid;gap:var(--grid-gap);justify-items:stretch;align-items:stretch;margin:auto;}
  .drag-ghost,
  .pointer-ghost{
    position:fixed;
    top:0;
    left:0;
    pointer-events:none;
    z-index:2000;
    transform:translate(-9999px,-9999px);
  }
  .drag-ghost{z-index:0;}
  .b{width:100%;height:100%;background:var(--block);border-radius:var(--pip-radius);box-shadow:none;}
  .modal{position:fixed;inset:0;display:none;align-items:flex-end;justify-content:center;padding:clamp(24px,6vw,40px);background:transparent;z-index:100;pointer-events:none;}
  .modal.show{display:flex;}
  .sheet{display:none;}
  .score{font-variant-numeric:tabular-nums;}
  .play-again-btn{width:min(420px, 90vw);pointer-events:auto;font-family:'Amiko','SF Pro Display','SF Pro Text','SF Pro','-apple-system',BlinkMacSystemFont,'Segoe UI',system-ui,sans-serif;font-weight:600;}
  body.game-over-active .board,
  body.game-over-active .tray{opacity:.25;}
  .btn{background:var(--button-bg);color:var(--button-text);border:none;border-radius:999px;padding:16px 24px;font-size:clamp(18px,5vw,22px);text-transform:lowercase;letter-spacing:.08em;font-weight:500;box-shadow:0 20px 50px rgba(0,0,0,.18);cursor:pointer;}
  .menu-layer{position:fixed;inset:0;display:flex;align-items:flex-start;justify-content:flex-end;padding:clamp(12px,4vw,24px);background:transparent;pointer-events:none;opacity:0;transition:opacity var(--transition-fast) ease;z-index:80;}
  .menu-layer::before{content:'';position:absolute;inset:0;background:transparent;}
  .menu-layer[data-open="true"]{pointer-events:auto;opacity:1;}
  .menu-panel{position:relative;background:var(--panel-bg);color:var(--text);border-radius:22px;padding:10px 10px 14px;box-shadow:var(--shadow);border:1px solid var(--panel-border);width:min(280px, 86vw);transform:translateX(40px);opacity:0;transition:transform var(--transition-fast) ease, opacity var(--transition-fast) ease;--swipe-shift:0px;margin-top:0;}
  #settingsMenu .menu-panel{background:var(--settings-surface);border-color:var(--settings-border);box-shadow:var(--settings-shadow);padding:16px 18px 18px;border-radius:26px;width:min(340px, 92vw);}
  #paletteMenu .menu-panel{width:auto;max-width:90vw;display:inline-flex;}
  .menu-layer[data-open="true"] .menu-panel{opacity:1;transform:translateX(calc(var(--swipe-shift, 0px)));}
  .menu-section{display:flex;flex-direction:column;gap:16px;}
  .menu-row{display:flex;align-items:center;justify-content:flex-start;gap:14px;font-size:18px;font-weight:500;line-height:1.2;}
  .menu-row > *:last-child{margin-left:auto;}
  .menu-row--theme{gap:12px;}
  .menu-row--theme .segmented{margin-left:auto;width:100%;max-width:270px;}
  .toggle{width:64px;height:36px;border-radius:999px;background:var(--toggle-bg);padding:5px;border:1px solid var(--settings-border);display:flex;align-items:center;transition:background .2s ease, box-shadow .2s ease;cursor:pointer;box-shadow:inset 0 1px 0 rgba(255,255,255,.35), 0 10px 24px rgba(17,20,30,.12);}
  .toggle[aria-checked="true"]{background:var(--accent);box-shadow:0 10px 24px rgba(17,20,30,.16);border-color:transparent;}
  .toggle-thumb{width:26px;height:26px;border-radius:50%;background:var(--toggle-thumb);transition:transform .2s ease;transform:translateX(0);box-shadow:0 8px 18px rgba(17,20,30,.18);}
  .toggle[aria-checked="true"] .toggle-thumb{transform:translateX(28px);}
  .segmented{display:flex;align-items:center;background:var(--segmented-track);border-radius:999px;padding:6px;border:1px solid var(--settings-border);gap:8px;box-shadow:inset 0 1px 0 rgba(255,255,255,.4), 0 12px 30px rgba(17,20,30,.12);}
  .segment{flex:1 1 0;border:none;border-radius:999px;padding:9px 14px;font-size:16px;font-weight:500;color:var(--text);background:transparent;cursor:pointer;transition:background .2s ease, color .2s ease, transform .15s ease, box-shadow .2s ease;}
  .segment.active{background:var(--segment-active-bg);color:var(--segment-active-text);box-shadow:0 10px 24px rgba(17,20,30,.18);}
  .palette-grid{display:flex;gap:10px;align-items:flex-start;flex-wrap:nowrap;}
  .palette-option{
    border:1px solid transparent;
    border-radius:14px;
    background:transparent;
    padding:6px;
    box-shadow:none;
    display:flex;
    justify-content:center;
    align-items:center;
    transition:transform .2s ease, box-shadow .2s ease, background .2s ease;
    cursor:pointer;
    min-width:0;
  }
  .palette-option.active{
    box-shadow:0 0 0 2px var(--panel-border);
    background:rgba(0,0,0,.06);
    border-color:var(--panel-border);
  }
  .palette-device{
    display:flex;
    flex-direction:column;
    gap:4px;
    width:auto;
  }
  .palette-swatch{
    width:28px;
    height:28px;
    border-radius:9px;
    background:var(--swatch-color,#ccc);
    border:none;
    box-shadow:none;
  }
</style>

</head>
<body>
  <div class="topbar" id="topbar">
    <div class="controls-row">
      <button class="icon-btn" id="resetBtn" aria-label="Reset game">
        <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
          <path d="M3 4v6h6"></path>
          <path d="M21 20v-6h-6"></path>
      <path d="M5.64 17.66a9 9 0 0 0 12.73 0L21 15"></path>
      <path d="M3 9l2.64-2.66a9 9 0 0 1 12.73 0L21 9"></path>
        </svg>
      </button>
      <button class="icon-btn" id="paletteBtn" aria-label="Color palettes" aria-haspopup="true">
        <span class="sf-icon palette-icon" aria-hidden="true"></span>
      </button>
      <button class="icon-btn" id="settingsBtn" aria-label="Settings" aria-haspopup="true">
        <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
          <path d="M12 15.2A3.2 3.2 0 1 0 12 8.8a3.2 3.2 0 0 0 0 6.4Z"></path>
          <path d="M19.4 15a1.54 1.54 0 0 0 .31 1.7l.06.06a1.91 1.91 0 1 1-2.7 2.7l-.06-.06a1.54 1.54 0 0 0-1.7-.31 1.54 1.54 0 0 0-.94 1.41v.18a1.91 1.91 0 1 1-3.82 0v-.09a1.54 1.54 0 0 0-1-1.41 1.54 1.54 0 0 0-1.7.31l-.06.06a1.91 1.91 0 0 1-2.7-2.7l.06-.06a1.54 1.54 0 0 0 .31-1.7 1.54 1.54 0 0 0-1.41-.94H3.1a1.91 1.91 0 0 1 0-3.82h.09a1.54 1.54 0 0 0 1.41-1 1.54 1.54 0 0 0-.31-1.7l-.06-.06a1.91 1.91 0 1 1 2.7-2.7l.06.06a1.54 1.54 0 0 0 1.7.31 1.54 1.54 0 0 0 .94-1.41V3.1a1.91 1.91 0 0 1 3.82 0v.09a1.54 1.54 0 0 0 1 1.41 1.54 1.54 0 0 0 1.7-.31l.06-.06a1.91 1.91 0 1 1 2.7 2.7l-.06.06a1.54 1.54 0 0 0-.31 1.7 1.54 1.54 0 0 0 1.41.94h.18a1.91 1.91 0 1 1 0 3.82h-.09a1.54 1.54 0 0 0-1.41.94Z"></path>
        </svg>
      </button>
    </div>
    <div class="score-stack" aria-label="Scoreboard">
      <div class="score-value" id="score">0</div>
      <div class="best-row">
        <span class="sf-icon crown-icon" aria-hidden="true"></span>
        <span class="best-value" id="bestScore">0</span>
      </div>
    </div>
  </div>

  <div class="menu-layer" id="paletteMenu" aria-hidden="true">
    <div class="menu-panel" role="dialog" aria-label="Color palettes">
      <div class="palette-grid" id="palettePanel"></div>
    </div>
  </div>

  <div class="menu-layer" id="settingsMenu" aria-hidden="true">
    <div class="menu-panel" role="dialog" aria-label="Settings">
      <div class="menu-section">
        <div class="menu-row">
          <span>Sound</span>
          <button class="toggle" id="soundToggle" type="button" role="switch" aria-checked="true">
            <span class="toggle-thumb"></span>
          </button>
        </div>
        <div class="menu-row menu-row--theme">
          <span>Themes</span>
          <div class="segmented" id="themeSegment" role="group" aria-label="Theme mode">
            <button type="button" class="segment" data-theme-mode="auto">Auto</button>
            <button type="button" class="segment" data-theme-mode="light">Light</button>
            <button type="button" class="segment" data-theme-mode="dark">Dark</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div id="board" class="board" aria-label="game board" role="grid"></div>
    <div class="tray" id="tray" aria-label="piece tray"></div>
  </div>

  <div class="modal" id="gameOver">
    <button class="btn play-again-btn" id="againBtn">play again</button>
  </div>

<script>
/* ------- Minimal 1010 (drag-and-drop) ------- */
const BOARD=10, EMPTY=0;
const CLEAR_DELAY_STEP_MS=40;
const TRAY_SCALE=0.64;
const MIN_TRAY_CELL=15;
const MIN_TRAY_GAP=3;
const STORAGE_KEYS={
  palette:'1010-palette',
  state:'1010-state',
  best:'1010-best',
  theme:'1010-theme',
  sound:'1010-sound'
};
const THEME_MODES={AUTO:'auto', LIGHT:'light', DARK:'dark'};
const THEME_COLORS={light:'#F5F1ED', dark:'#243042'};
const PALETTES=[
  {id:'blue', name:'Blue', colors:['#BFCED9','#8FA9BC','#60859F']},
  {id:'green', name:'Green', colors:['#BFD9C8','#8FBC9E','#609F75']},
  {id:'teal', name:'Teal', colors:['#BFD9D7','#8FBCB8','#609F9A']},
  {id:'brick', name:'Brick', colors:['#D9BFBF','#BC8F8F','#9F6060']}
];
let grid, score=0, tray=new Array(3).fill(null), selected=null;
let boardCellSize=0, boardGap=4, isClearing=false;
let pendingAnchor=null, pendingAnchorIdx=null;
let pendingAnchorRect=null;
let currentPreview=null;
let draggingPiece=false;
let resizeScheduled=false;
let currentBoardPixels=0;
let pointerDragId=null;
let pointerCaptureTarget=null;
let dragGhost=null;
let pointerGhost=null;
let pointerAnchorOffset={x:0,y:0};
let pointerDragType=null;
let currentPaletteId=PALETTES[0].id;
let bestScore=0;
let lastPlacementColor=null;
let lastPlacementTone=null;
let openMenu=null;
let themeMode=THEME_MODES.AUTO;
let soundEnabled=true;
const isCoarsePointer=window.matchMedia && window.matchMedia('(pointer:coarse)').matches;
const themeWatcher=window.matchMedia('(prefers-color-scheme: dark)');
const themeMeta=document.querySelector('meta[name=\"theme-color\"]');

const ZERO_ANCHOR=()=>({dx:0,dy:0});

function getCurrentPalette(){
  return PALETTES.find(p=>p.id===currentPaletteId) || PALETTES[0];
}

function clampToneIndex(tone,palette=getCurrentPalette()){
  const colors=(palette && Array.isArray(palette.colors)) ? palette.colors : [];
  const max=Math.max(0, colors.length-1);
  if(!Number.isFinite(tone)) return Math.min(1, max);
  return Math.min(max, Math.max(0, tone));
}

function getPaletteColor(tone,palette=getCurrentPalette()){
  const colors=(palette && Array.isArray(palette.colors) && palette.colors.length) ? palette.colors : null;
  if(!colors || !colors.length){
    const fallback=document.documentElement.style.getPropertyValue('--block') || '#6F8FA6';
    return fallback.trim();
  }
  const idx=clampToneIndex(tone,palette);
  return colors[idx];
}

function pickToneIndex(){
  const palette=getCurrentPalette();
  const colors=(palette && Array.isArray(palette.colors)) ? palette.colors : [];
  if(!colors.length) return 0;
  return Math.floor(Math.random()*colors.length);
}

function assignPieceColor(piece, toneOverride=null){
  if(!piece) return piece;
  const palette=getCurrentPalette();
  const tone=Number.isFinite(toneOverride) ? clampToneIndex(toneOverride,palette) : pickToneIndex();
  piece.tone=tone;
  piece.color=getPaletteColor(tone,palette);
  return piece;
}

function cloneShape(shape){
  if(!Array.isArray(shape)) return [];
  return shape.map(point=>Array.isArray(point)?[point[0],point[1]]:[0,0]);
}

function clonePiece(piece){
  if(!piece) return null;
  return {
    shape:cloneShape(piece.shape),
    color:piece.color || getPaletteColor(Number.isFinite(piece.tone)?piece.tone:1),
    tone:Number.isFinite(piece.tone)?piece.tone:null
  };
}

function saveGameState(){
  if(!grid || !Array.isArray(tray)) return;
  const state={
    score,
    grid:grid.map(row=>row.map(cell=>{
      if(cell===EMPTY || cell==null) return EMPTY;
      const tone=Number.isFinite(cell.tone)?cell.tone:clampToneIndex(cell.tone);
      return {tone, color:cell.color || getPaletteColor(tone)};
    })),
    tray:tray.map(clonePiece)
  };
  try{
    localStorage.setItem(STORAGE_KEYS.state, JSON.stringify(state));
  }catch(err){}
}

function clearSavedGame(){
  try{
    localStorage.removeItem(STORAGE_KEYS.state);
  }catch(err){}
}

function restoreSavedGame(){
  let raw=null;
  try{
    raw=localStorage.getItem(STORAGE_KEYS.state);
  }catch(err){
    raw=null;
  }
  if(!raw) return false;
  let data=null;
  try{
    data=JSON.parse(raw);
  }catch(err){
    data=null;
  }
  if(!data || typeof data.score!=='number' || !Array.isArray(data.grid) || data.grid.length!==BOARD) return false;
  const normalizeCell=value=>{
    if(value===EMPTY || value==null) return EMPTY;
    if(typeof value==='string'){
      return {tone:1, color:value};
    }
    if(typeof value==='object'){
      const tone=Number.isFinite(value.tone)?clampToneIndex(value.tone):1;
      const color=value.color || getPaletteColor(tone);
      return {tone, color};
    }
    return EMPTY;
  };
  grid=data.grid.map(row=>{
    if(!Array.isArray(row)) return Array(BOARD).fill(EMPTY);
    const copy=row.slice(0,BOARD);
    while(copy.length<BOARD) copy.push(EMPTY);
    return copy.map(normalizeCell);
  });
  tray=new Array(3).fill(null);
  if(Array.isArray(data.tray)){
    for(let i=0;i<Math.min(3,data.tray.length);i++){
      const piece=data.tray[i];
      if(piece && Array.isArray(piece.shape)){
        const restored={shape:cloneShape(piece.shape)};
        const tone=Number.isFinite(piece.tone)?piece.tone:null;
        assignPieceColor(restored, tone);
        if(piece.color && !Number.isFinite(tone)){
          restored.color=piece.color;
        }
        tray[i]=restored;
      }
    }
  }
  score=data.score;
  scoreEl.textContent=score;
  reapplyPaletteToBoard();
  updateBoardCells();
  renderTray();
  return true;
}

function getSelectedAnchor(){
  return (selected && selected.anchor) ? selected.anchor : ZERO_ANCHOR();
}

function buildPlacementOffsets(shape){
  const anchor=getSelectedAnchor();
  const offsets=[];
  const seen=new Set();
  const add=(dx,dy)=>{
    const key=`${dx},${dy}`;
    if(!seen.has(key)){ seen.add(key); offsets.push({dx,dy}); }
  };
  add(anchor.dx, anchor.dy);
  shape.forEach(([dx,dy])=>add(dx,dy));
  return offsets;
}

function findPlacementOrigin(x,y){
  if(!selected || !selected.shape || !Number.isFinite(x) || !Number.isFinite(y)) return null;
  const shape=selected.shape;
  const offsets=buildPlacementOffsets(shape);
  for(const off of offsets){
    const ox=x-off.dx, oy=y-off.dy;
    if(canPlaceAt(ox,oy,shape)) return {ox,oy};
  }
  return null;
}

function computeBoardPixels(){
  const rootStyles=getComputedStyle(document.documentElement);
  const maxWidth=parseFloat(rootStyles.getPropertyValue('--max-width')) || 520;
  const vw=Math.min(window.innerWidth, document.documentElement.clientWidth || window.innerWidth);
  const bodyStyles=getComputedStyle(document.body);
  const horizontalPadding=parseFloat(bodyStyles.paddingLeft)+parseFloat(bodyStyles.paddingRight);
  const verticalPadding=parseFloat(bodyStyles.paddingTop)+parseFloat(bodyStyles.paddingBottom);
  const topbar=document.querySelector('.topbar');
  const wrap=document.querySelector('.wrap');
  const topHeight=topbar?topbar.offsetHeight:0;
  const wrapGap=wrap?parseFloat(getComputedStyle(wrap).gap)||0:0;
  const trayHeight=trayEl?trayEl.offsetHeight:0;
  const estimatedCell=Math.max(18, (currentBoardPixels || Math.min(maxWidth, vw))/BOARD);
  const sideMargin=Math.max(estimatedCell/2, 10);
  const marginReduction=Math.max(0, horizontalPadding - sideMargin*2);
  let availableWidth=Math.min(maxWidth, vw - marginReduction);
  availableWidth=Math.max(180, availableWidth);
  let availableHeight=window.innerHeight - (verticalPadding + topHeight + wrapGap + trayHeight + 16);
  if(!Number.isFinite(availableHeight) || availableHeight<=0) availableHeight=availableWidth;
  let size=Math.min(availableWidth, availableHeight);
  return Math.max(180, size);
}

function applyBoardSize(){
  const size=computeBoardPixels();
  if(Math.abs(size-currentBoardPixels)<=1) return;
  currentBoardPixels=size;
  document.documentElement.style.setProperty('--board-size', size+'px');
  window.requestAnimationFrame(()=>{ recomputeBoardMetrics(); });
}

function scheduleResponsiveSize(){
  if(resizeScheduled) return;
  resizeScheduled=true;
  window.requestAnimationFrame(()=>{
    resizeScheduled=false;
    applyBoardSize();
    setTimeout(applyBoardSize, 80);
  });
}

function recomputeBoardMetrics(){
  const someCell=boardEl.firstElementChild;
  if(!someCell) return;
  const newSize=Math.round(someCell.getBoundingClientRect().width);
  if(!newSize || newSize===boardCellSize) return;
  boardCellSize=newSize;
  const rootStyles=getComputedStyle(document.documentElement);
  const baseGap=parseFloat(rootStyles.getPropertyValue('--grid-gap')) || 4;
  boardGap=baseGap;
  if(trayEl){
    const trayGap=Math.max(8, baseGap*2);
    trayEl.style.setProperty('--piece-gap', trayGap+'px');
  }
  const baseRadius=parseFloat(rootStyles.getPropertyValue('--cell-radius')) || 8;
  document.documentElement.style.setProperty('--cell-radius', baseRadius+'px');
  document.documentElement.style.setProperty('--pip-radius', Math.max(0, baseRadius-2)+'px');
  const slotHeight=Math.max(130, Math.min(240, boardCellSize*3));
  document.documentElement.style.setProperty('--tray-slot-height', slotHeight+'px');
  renderTray();
}

const SHAPES=[
  [[0,0]],
  [[0,0],[1,0]], [[0,0],[0,1]],
  [[0,0],[1,0],[2,0]], [[0,0],[0,1],[0,2]],
  [[0,0],[1,0],[2,0],[3,0]], [[0,0],[0,1],[0,2],[0,3]],
  [[0,0],[1,0],[2,0],[3,0],[4,0]], [[0,0],[0,1],[0,2],[0,3],[0,4]],
  [[0,0],[1,0],[0,1],[1,1]],
  [[0,0],[1,0],[2,0],[0,1],[1,1],[2,1],[0,2],[1,2],[2,2]],
  [[0,0],[0,1],[0,2],[1,2]],
  [[0,0],[1,0],[2,0],[1,1]],
  [[0,0],[1,0],[1,1],[2,1]],
  [[0,0],[0,1],[1,1],[1,2]],
  [[0,0],[0,1],[1,1]],
  [[0,0],[1,0],[2,0],[2,1]],
];

const topbarEl=document.getElementById('topbar');
const boardEl=document.getElementById('board');
const trayEl=document.getElementById('tray');
const scoreEl=document.getElementById('score');
const gameOverEl=document.getElementById('gameOver');
const bestScoreEl=document.getElementById('bestScore');
const paletteBtn=document.getElementById('paletteBtn');
const settingsBtn=document.getElementById('settingsBtn');
const palettePanel=document.getElementById('palettePanel');
const paletteMenuLayer=document.getElementById('paletteMenu');
const settingsMenu=document.getElementById('settingsMenu');
const soundToggle=document.getElementById('soundToggle');
const themeSegment=document.getElementById('themeSegment');
const themeButtons=themeSegment?Array.from(themeSegment.querySelectorAll('.segment')):[];
const menus={palette:paletteMenuLayer, settings:settingsMenu};

function buildPalettePanel(){
  if(!palettePanel) return;
  palettePanel.innerHTML='';
  PALETTES.forEach(palette=>{
    const btn=document.createElement('button');
    btn.className='palette-option';
    btn.dataset.palette=palette.id;
    btn.type='button';
    btn.title=palette.name;
    btn.setAttribute('aria-label', palette.name);
    btn.setAttribute('aria-pressed','false');
    const device=document.createElement('div');
    device.className='palette-device';
    palette.colors.forEach(color=>{
      const swatch=document.createElement('span');
      swatch.className='palette-swatch';
      swatch.style.setProperty('--swatch-color', color);
      device.appendChild(swatch);
    });
    btn.appendChild(device);
    btn.addEventListener('click',()=>{
      applyPalette(palette.id,true);
    });
    palettePanel.appendChild(btn);
  });
  updatePaletteSelection();
}

function updatePaletteSelection(){
  if(!palettePanel) return;
  palettePanel.querySelectorAll('.palette-option').forEach(btn=>{
    const active=btn.dataset.palette===currentPaletteId;
    btn.classList.toggle('active', active);
    btn.setAttribute('aria-pressed', active?'true':'false');
  });
}

function applyPalette(id, persist=false){
  const palette=PALETTES.find(p=>p.id===id) || PALETTES[0];
  currentPaletteId=palette.id;
  const midColor=palette.colors[Math.min(1, palette.colors.length-1)] || palette.colors[0];
  document.documentElement.style.setProperty('--block', midColor);
  tray=tray.map(piece=>piece?assignPieceColor(piece, Number.isFinite(piece.tone)?piece.tone:null):piece);
  if(selected){
    const tone=Number.isFinite(selected.tone)?selected.tone:1;
    selected.color=getPaletteColor(tone,palette);
  }
  if(Number.isFinite(lastPlacementTone)){
    lastPlacementColor=getPaletteColor(lastPlacementTone,palette);
  }
  reapplyPaletteToBoard();
  updatePaletteSelection();
  renderTray();
  if(persist){
    try{ localStorage.setItem(STORAGE_KEYS.palette,currentPaletteId); }catch(err){}
  }
}

function reapplyPaletteToBoard(){
  if(!Array.isArray(grid)) return;
  grid.forEach(row=>{
    row.forEach(cell=>{
      if(cell && cell!==EMPTY){
        const tone=Number.isFinite(cell.tone)?cell.tone:1;
        cell.color=getPaletteColor(tone);
      }
    });
  });
  updateBoardCells();
}

function normalizeThemeMode(mode){
  if(mode===THEME_MODES.LIGHT || mode==='light') return THEME_MODES.LIGHT;
  if(mode===THEME_MODES.DARK || mode==='dark') return THEME_MODES.DARK;
  return THEME_MODES.AUTO;
}

function applyTheme(mode=themeMode, persist=false){
  themeMode=normalizeThemeMode(mode);
  const resolved=themeMode===THEME_MODES.AUTO
    ? (themeWatcher && themeWatcher.matches ? THEME_MODES.DARK : THEME_MODES.LIGHT)
    : themeMode;
  document.documentElement.setAttribute('data-theme-mode', themeMode);
  document.documentElement.setAttribute('data-theme', resolved);
  if(themeMeta){
    const color=resolved===THEME_MODES.DARK ? THEME_COLORS.dark : THEME_COLORS.light;
    themeMeta.setAttribute('content', color);
  }
  if(persist){
    try{ localStorage.setItem(STORAGE_KEYS.theme, themeMode); }catch(err){}
  }
  updateThemeControls();
}

function updateThemeControls(){
  if(!themeButtons.length) return;
  themeButtons.forEach(btn=>{
    const value=btn.dataset.themeMode || THEME_MODES.AUTO;
    const active=value===themeMode;
    btn.classList.toggle('active', active);
    btn.setAttribute('aria-pressed', active?'true':'false');
  });
}

function loadThemePreference(){
  let saved=null;
  try{
    saved=localStorage.getItem(STORAGE_KEYS.theme);
  }catch(err){
    saved=null;
  }
  themeMode=normalizeThemeMode(saved);
  applyTheme(themeMode,false);
  if(themeWatcher && typeof themeWatcher.addEventListener==='function'){
    themeWatcher.addEventListener('change', ()=>{
      if(themeMode===THEME_MODES.AUTO){
        applyTheme(THEME_MODES.AUTO,false);
      }
    });
  }
}

function updateSoundToggle(){
  if(soundToggle){
    soundToggle.setAttribute('aria-checked', soundEnabled?'true':'false');
  }
}

function loadSoundPreference(){
  let saved=null;
  try{
    saved=localStorage.getItem(STORAGE_KEYS.sound);
  }catch(err){
    saved=null;
  }
  if(saved===null){
    soundEnabled=true;
  }else{
    soundEnabled=saved==='true';
  }
  updateSoundToggle();
}

function openMenuLayer(name){
  const layer=menus[name];
  if(!layer || openMenu===name) return;
  layer.dataset.open='true';
  layer.setAttribute('aria-hidden','false');
  const panel=layer.querySelector('.menu-panel');
  if(panel){
    panel.style.setProperty('--swipe-shift','0px');
  }
  openMenu=name;
}

function closeMenuLayer(){
  if(!openMenu) return;
  const layer=menus[openMenu];
  if(layer){
    layer.removeAttribute('data-open');
    layer.setAttribute('aria-hidden','true');
    const panel=layer.querySelector('.menu-panel');
    if(panel){
      panel.style.removeProperty('--swipe-shift');
    }
  }
  openMenu=null;
}

function setupMenuLayers(){
  Object.values(menus).forEach(layer=>{
    if(!layer) return;
    const panel=layer.querySelector('.menu-panel');
    layer.addEventListener('pointerdown', e=>{
      if(layer.dataset.open!=='true') return;
      if(panel && panel.contains(e.target)) return;
      closeMenuLayer();
    });
    enableSwipeDismiss(layer,panel);
  });
}

function enableSwipeDismiss(layer,panel){
  if(!layer || !panel) return;
  const handle=panel.querySelector('[data-swipe-handle]');
  if(!handle) return;
  let swipeId=null;
  let startX=0;
  let startY=0;
  const resetShift=()=>panel.style.setProperty('--swipe-shift','0px');
  handle.addEventListener('pointerdown', e=>{
    if(layer.dataset.open!=='true') return;
    if(e.pointerType!=='touch' && e.pointerType!=='pen') return;
    swipeId=e.pointerId;
    startX=e.clientX;
    startY=e.clientY;
    try{ handle.setPointerCapture(e.pointerId); }catch(err){}
  });
  handle.addEventListener('pointermove', e=>{
    if(layer.dataset.open!=='true' || swipeId==null || e.pointerId!==swipeId) return;
    const dx=e.clientX-startX;
    const dy=Math.abs(e.clientY-startY);
    if(dx>0 && dy<60){
      panel.style.setProperty('--swipe-shift', `${Math.min(dx, 120)}px`);
    }
  });
  const finishSwipe=e=>{
    if(swipeId==null || e.pointerId!==swipeId) return;
    const dx=e.clientX-startX;
    if(dx>80){
      closeMenuLayer();
    }else{
      resetShift();
    }
    swipeId=null;
    try{ handle.releasePointerCapture(e.pointerId); }catch(err){}
  };
  handle.addEventListener('pointerup', finishSwipe);
  handle.addEventListener('pointercancel', e=>{
    if(swipeId==null || e.pointerId!==swipeId) return;
    resetShift();
    swipeId=null;
    try{ handle.releasePointerCapture(e.pointerId); }catch(err){}
  });
}

function loadSavedPalette(){
  let saved=null;
  try{
    saved=localStorage.getItem(STORAGE_KEYS.palette);
  }catch(err){
    saved=null;
  }
  applyPalette(saved || currentPaletteId, false);
}

function loadBestScore(){
  let saved=null;
  try{
    saved=localStorage.getItem(STORAGE_KEYS.best);
  }catch(err){
    saved=null;
  }
  const parsed=parseInt(saved,10);
  bestScore=Number.isFinite(parsed) && parsed>0 ? parsed : 0;
  updateBestScoreDisplay();
}

function updateBestScoreDisplay(){
  if(bestScoreEl) bestScoreEl.textContent=bestScore;
}

function freezeTopbar(){
  if(topbarEl) topbarEl.classList.add('frozen');
}
function unfreezeTopbar(){
  if(topbarEl) topbarEl.classList.remove('frozen');
}

function recordBestScore(){
  if(score>bestScore){
    bestScore=score;
    updateBestScoreDisplay();
    try{ localStorage.setItem(STORAGE_KEYS.best,String(bestScore)); }catch(err){}
  }
}

function toggleMinimalTop(){
  if(!topbarEl) return;
  topbarEl.classList.toggle('minimal');
}

function hideGameOver(){
  if(gameOverEl) gameOverEl.classList.remove('show');
  document.body.classList.remove('game-over-active');
  unfreezeTopbar();
}

buildPalettePanel();
loadSavedPalette();
loadBestScore();
loadThemePreference();
loadSoundPreference();
setupMenuLayers();

function buildBoard(){
  boardEl.innerHTML='';
  for(let i=0;i<BOARD*BOARD;i++){
    const d=document.createElement('div');
    d.className='cell';
    d.dataset.x=(i%BOARD);
    d.dataset.y=Math.floor(i/BOARD);
    d.addEventListener('pointerenter', previewHover);
    d.addEventListener('pointerleave', ()=>{ if(selected && !draggingPiece) clearPreviewAll(); });
    d.addEventListener('dragover', handleDragOver);
    d.addEventListener('drop', handleDrop);
    boardEl.appendChild(d);
  }
  const someCell=boardEl.firstElementChild;
  boardCellSize=Math.round(someCell.getBoundingClientRect().width);
}

function newGrid(){ grid=Array.from({length:BOARD},()=>Array(BOARD).fill(EMPTY)); updateBoardCells(); }
function dealPiece(){
  return assignPieceColor({shape: JSON.parse(JSON.stringify(SHAPES[Math.floor(Math.random()*SHAPES.length)]))});
}
function refillTray(force=false){
  if(!Array.isArray(tray) || tray.length!==3){
    tray=new Array(3).fill(null);
  }
  const needsRefill = force || tray.every(slot=>!slot);
  if(needsRefill){
    for(let i=0;i<tray.length;i++){
      tray[i]=dealPiece();
    }
  }
  selected=null;
  clearPreviewAll();
  clearPendingAnchor();
  renderTray();
  saveGameState();
}

function drawPiece(container,shape,{fullSize=false,color=null,skipSizing=false}={}){
  container.innerHTML='';
  const xs=shape.map(s=>s[0]), ys=shape.map(s=>s[1]);
  const w=Math.max(...xs)+1, h=Math.max(...ys)+1;
  const baseCell=boardCellSize || 32;
  const baseGap=boardGap || 6;
  const miniCell=Math.max(MIN_TRAY_CELL, Math.round(baseCell*TRAY_SCALE));
  const miniGap=Math.max(MIN_TRAY_GAP, Math.round(baseGap*TRAY_SCALE));
  const cellSize=fullSize ? baseCell : miniCell;
  const gap=fullSize ? baseGap : miniGap;
  const fillColor=(color || getPaletteColor(1) || document.documentElement.style.getPropertyValue('--block') || '#6F8FA6').trim();
  const width=(w*cellSize)+Math.max(0,w-1)*gap;
  const height=(h*cellSize)+Math.max(0,h-1)*gap;
  container.style.display='grid';
  container.style.width=width+'px';
  container.style.height=height+'px';
  container.style.gridTemplateColumns=`repeat(${w}, ${cellSize}px)`;
  container.style.gridTemplateRows=`repeat(${h}, ${cellSize}px)`;
  container.style.gap=gap+'px';
  shape.forEach(([x,y])=>{
    const b=document.createElement('div'); b.className='b';
    b.dataset.cx=x;
    b.dataset.cy=y;
    b.style.gridColumn=(x+1);
    b.style.gridRow=(y+1);
    b.style.background=fillColor;
    container.appendChild(b);
  });
}

function createDragGhost(shape,color){
  const ghost=document.createElement('div');
  ghost.className='drag-ghost';
  ghost.style.padding='0';
  ghost.style.margin='0';
  ghost.style.background='transparent';
  document.body.appendChild(ghost);
  drawPiece(ghost,shape,{fullSize:true,color});
  return ghost;
}

function createPointerGhost(shape,color){
  removePointerGhost();
  pointerGhost=document.createElement('div');
  pointerGhost.className='pointer-ghost';
  document.body.appendChild(pointerGhost);
  pointerGhost.style.transform='translate(-9999px,-9999px)';
  drawPiece(pointerGhost,shape,{fullSize:true,color});
  return pointerGhost;
}

function getAnchorCenterOffsetPx(){
  const anchor=getSelectedAnchor();
  const cell=boardCellSize || 32;
  const gap=boardGap || 6;
  return {
    x:(anchor.dx||0)*(cell+gap) + cell/2,
    y:(anchor.dy||0)*(cell+gap) + cell/2
  };
}

function updatePointerGhostPosition(e){
  if(!pointerGhost) return;
  const anchorPoint=getAnchorPointFromEvent(e);
  const offset=getAnchorCenterOffsetPx();
  const left=anchorPoint.x - offset.x;
  const top=anchorPoint.y - offset.y;
  pointerGhost.style.transform=`translate(${left}px, ${top}px)`;
}

function removePointerGhost(){
  if(pointerGhost){
    pointerGhost.remove();
    pointerGhost=null;
  }
}

function renderTray(){
  trayEl.innerHTML='';
  tray.forEach((p,idx)=>{
    const card=document.createElement('div');
    const hasPiece=!!p;
    const isActive=hasPiece && selected && selected.idx===idx;
    const isDraggingActive=isActive && draggingPiece;
    card.className='piece'+(isActive?' selected':'')+(isDraggingActive?' dragging':'')+(hasPiece?'':' empty');
    if(hasPiece){
      const enableNativeDrag=!isCoarsePointer;
      card.setAttribute('draggable', enableNativeDrag ? 'true' : 'false');
      card.addEventListener('pointerdown', e=>handlePiecePointerDown(e,idx));
      if(enableNativeDrag){
        card.addEventListener('dragstart', e=>beginDrag(e,idx));
        card.addEventListener('dragend', finishDrag);
      }
      const inner=document.createElement('div'); inner.className='piece-inner'; card.appendChild(inner);
      drawPiece(inner,p.shape,{fullSize:false,color:p.color});
      if(isActive && !draggingPiece){
        const overlay=document.createElement('div');
        overlay.className='piece-overlay';
        card.appendChild(overlay);
        drawPiece(overlay,p.shape,{fullSize:true,color:p.color, skipSizing:true});
      }
    }else{
      card.setAttribute('aria-hidden','true');
    }
    trayEl.appendChild(card);
  });
}

function handlePiecePointerDown(e,idx){
  if(!tray[idx]) return;
  rememberAnchor(e,idx);
  capturePointerAnchorOffset(e);
  if(e.pointerType==='mouse' || e.pointerType==='pen'){
    return;
  }
  if(isClearing || draggingPiece) return;
  e.preventDefault();
  startPointerDrag(e,idx);
}

function startPointerDrag(e,idx){
  const piece=tray[idx];
  if(!piece) return;
  pointerDragType=e.pointerType || (isCoarsePointer?'touch':'mouse');
  const anchor = takeAnchorFromDrag(e,idx);
  selected={
    shape:piece.shape,
    idx,
    anchor,
    color:piece.color,
    tone:Number.isFinite(piece.tone)?piece.tone:null
  };
  setTimeout(()=>renderTray(),0);
  draggingPiece=true;
  pointerDragId=e.pointerId;
  pointerCaptureTarget=e.currentTarget;
  if(pointerCaptureTarget && pointerCaptureTarget.setPointerCapture){
    try{ pointerCaptureTarget.setPointerCapture(e.pointerId); }catch(err){}
  }
  pointerGhost=createPointerGhost(piece.shape,piece.color);
  boardEl.classList.add('dragging');
  window.addEventListener('pointermove', handlePointerMove);
  window.addEventListener('pointerup', handlePointerUp);
  window.addEventListener('pointercancel', handlePointerCancel);
  updatePointerPreview(e);
  updatePointerGhostPosition(e);
}

function handlePointerMove(e){
  if(e.pointerId!==pointerDragId) return;
  e.preventDefault();
  updatePointerPreview(e);
  updatePointerGhostPosition(e);
}

function handlePointerUp(e){
  if(e.pointerId!==pointerDragId) return;
  e.preventDefault();
  finalizePointerDrag(e);
}

function handlePointerCancel(e){
  if(e.pointerId!==pointerDragId) return;
  e.preventDefault();
  cancelPointerDrag();
}

function updatePointerPreview(e){
  const anchorPoint=getAnchorPointFromEvent(e);
  const cell=getCellFromCoords(anchorPoint.x, anchorPoint.y);
  if(cell){
    showPreviewAt(+cell.dataset.x, +cell.dataset.y);
  }else{
    clearPreviewAll();
  }
}

function finalizePointerDrag(e){
  cleanupPointerDragListeners();
  pointerDragId=null;
  const anchorPoint=getAnchorPointFromEvent(e);
  const cell=getCellFromCoords(anchorPoint.x, anchorPoint.y);
  let placed=false;
  if(cell){
    placed=attemptPlacement(+cell.dataset.x, +cell.dataset.y);
  }else if(currentPreview && currentPreview.origin){
    placed=attemptPlacement(null,null,currentPreview.origin);
  }
  if(!placed){
    finishDrag();
  }else{
    releaseDragUIState();
  }
}

function cancelPointerDrag(){
  cleanupPointerDragListeners();
  pointerDragId=null;
  finishDrag();
}

function cleanupPointerDragListeners(){
  window.removeEventListener('pointermove', handlePointerMove);
  window.removeEventListener('pointerup', handlePointerUp);
  window.removeEventListener('pointercancel', handlePointerCancel);
  releasePointerCapture();
}

function releasePointerCapture(){
  if(pointerCaptureTarget && pointerCaptureTarget.releasePointerCapture && pointerDragId!=null){
    try{ pointerCaptureTarget.releasePointerCapture(pointerDragId); }catch(err){}
  }
  pointerCaptureTarget=null;
}

function rememberAnchor(e,idx){
  const tile=e.target.closest('.b');
  if(tile){
    pendingAnchor={dx:+tile.dataset.cx, dy:+tile.dataset.cy};
    pendingAnchorIdx=idx;
    pendingAnchorRect=tile.getBoundingClientRect();
  }else{
    clearPendingAnchor();
  }
}

function clearPendingAnchor(){
  pendingAnchor=null;
  pendingAnchorIdx=null;
  pendingAnchorRect=null;
}

function takeAnchorFromDrag(e,idx){
  const pending = (pendingAnchorIdx===idx && pendingAnchor) ? pendingAnchor : null;
  clearPendingAnchor();
  const fromPoint = anchorFromPointer(e);
  return pending || fromPoint || ZERO_ANCHOR();
}

function anchorFromPointer(e){
  if(typeof e.clientX!=='number' || typeof e.clientY!=='number') return null;
  const el=document.elementFromPoint(e.clientX, e.clientY);
  const tile=el && el.closest('.b');
  if(tile && tile.dataset.cx!=null){
    return {dx:+tile.dataset.cx, dy:+tile.dataset.cy};
  }
  return null;
}

function capturePointerAnchorOffset(e){
  if(e && pendingAnchorRect){
    const cx=typeof e.clientX==='number' ? e.clientX : 0;
    const cy=typeof e.clientY==='number' ? e.clientY : 0;
    const centerX=pendingAnchorRect.left + pendingAnchorRect.width/2;
    const centerY=pendingAnchorRect.top + pendingAnchorRect.height/2;
    pointerAnchorOffset={
      x:cx-centerX,
      y:cy-centerY
    };
  }else{
    pointerAnchorOffset={x:0,y:0};
  }
}

function getAnchorPointFromEvent(e){
  const baseX=typeof e.clientX==='number' ? e.clientX : 0;
  const baseY=typeof e.clientY==='number' ? e.clientY : 0;
  const cell=boardCellSize || 32;
  const gap=boardGap || 6;
  const lift=(pointerDragType==='touch' || isCoarsePointer) ? Math.max((cell+gap)*2, 56) : 0;
  return {
    x:baseX - pointerAnchorOffset.x,
    y:baseY - pointerAnchorOffset.y - lift
  };
}

function getCellFromCoords(x,y){
  if(!Number.isFinite(x) || !Number.isFinite(y) || !boardEl) return null;
  const rect=boardEl.getBoundingClientRect();
  const styles=getComputedStyle(boardEl);
  const padX=parseFloat(styles.paddingLeft)||0;
  const padY=parseFloat(styles.paddingTop)||0;
  const innerLeft=rect.left+padX;
  const innerTop=rect.top+padY;
  const innerWidth=rect.width-(padX*2);
  const innerHeight=rect.height-(padY*2);
  if(x<innerLeft || x>innerLeft+innerWidth || y<innerTop || y>innerTop+innerHeight) return null;
  const gap=boardGap||0;
  const cellSize=boardCellSize || (innerWidth/BOARD);
  const stride=cellSize+gap;
  const col=Math.floor((x-innerLeft)/stride);
  const row=Math.floor((y-innerTop)/stride);
  if(col<0 || row<0 || col>=BOARD || row>=BOARD) return null;
  return document.querySelector(`.cell[data-x="${col}"][data-y="${row}"]`);
}

function beginDrag(e,idx){
  if(isClearing){ e.preventDefault(); return; }
  const piece=tray[idx];
  if(!piece) return;
  const anchor = takeAnchorFromDrag(e,idx);
  selected={
    shape:piece.shape,
    idx,
    anchor,
    color:piece.color,
    tone:Number.isFinite(piece.tone)?piece.tone:null
  };
  dragGhost=createDragGhost(piece.shape,piece.color);
  setTimeout(()=>renderTray(),0);
  draggingPiece=true;
  boardEl.classList.add('dragging');
  if(e.dataTransfer){
    if(dragGhost){
      const rect=dragGhost.getBoundingClientRect();
      e.dataTransfer.setDragImage(dragGhost, rect.width/2, rect.height/2);
    }
    e.dataTransfer.effectAllowed='move';
    e.dataTransfer.setData('text/plain', String(idx));
  }
}

function finishDrag(){
  releaseDragUIState();
  clearPreviewAll();
  selected=null;
  renderTray();
}

function releaseDragUIState(){
  boardEl.classList.remove('dragging');
  draggingPiece=false;
  pointerDragType=null;
  releasePointerCapture();
  removePointerGhost();
  pointerAnchorOffset={x:0,y:0};
  if(dragGhost){
    dragGhost.remove();
    dragGhost=null;
  }
}

function updateBoardCells(){
  if(!grid) return;
  document.querySelectorAll('.cell').forEach(c=>{
    const x=+c.dataset.x, y=+c.dataset.y;
    const cellValue=grid[y][x];
    const isFilled = cellValue!==EMPTY && cellValue!=null;
    const wasFilled=c.classList.contains('filled');
    c.classList.toggle('filled', isFilled);
    c.classList.remove('preview');
    if(isFilled){
      const fillColor=(typeof cellValue==='object' && cellValue)
        ? (cellValue.color || getPaletteColor(cellValue.tone))
        : cellValue;
      if(typeof cellValue==='object' && !cellValue.color){
        cellValue.color=fillColor;
      }
      c.style.setProperty('--cell-fill', fillColor);
      c.style.background=fillColor;
      c.style.boxShadow='none';
      if(!wasFilled){
        requestAnimationFrame(()=>{
          c.classList.add('animating-in');
          requestAnimationFrame(()=>{
            c.classList.remove('animating-in');
          });
        });
      }
    }else{
      c.style.removeProperty('--cell-fill');
      c.style.background='';
      c.style.boxShadow='';
    }
  });
}

function canPlaceAt(x,y,shape){
  return shape.every(([dx,dy])=>{
    const cx=x+dx, cy=y+dy;
    return cx>=0 && cy>=0 && cx<BOARD && cy<BOARD && grid[cy][cx]===EMPTY;
  });
}

function placeAt(x,y,shape,toneOverride=null){
  const tone=Number.isFinite(toneOverride)?clampToneIndex(toneOverride):pickToneIndex();
  const fillColor=getPaletteColor(tone);
  lastPlacementTone=tone;
  lastPlacementColor=fillColor;
  shape.forEach(([dx,dy])=>{
    grid[y+dy][x+dx]={tone,color:fillColor};
  });
  score += shape.length; scoreEl.textContent=score;
  recordBestScore();
  updateBoardCells();
  clearLines();
}

function clearLines(){
  const rows=[], cols=[];
  for(let y=0;y<BOARD;y++) if(grid[y].every(v=>v!==EMPTY)) rows.push(y);
  for(let x=0;x<BOARD;x++){
    let ok=true;
    for(let y=0;y<BOARD;y++) if(grid[y][x]===EMPTY){ ok=false; break; }
    if(ok) cols.push(x);
  }
  if(!rows.length && !cols.length) return;

  isClearing=true;
  const coords=new Set();
  const rowSet=new Set(rows);
  const colSet=new Set(cols);
  const delayStepSeconds=CLEAR_DELAY_STEP_MS/1000;
  let pendingAnimations=0;
  let resolved=false;
  const finishClear=()=>{
    if(resolved) return;
    resolved=true;
    isClearing=false;
  };
  rows.forEach(y=>{ for(let x=0;x<BOARD;x++) coords.add(`${x},${y}`); });
  cols.forEach(x=>{ for(let y=0;y<BOARD;y++) coords.add(`${x},${y}`); });

  const clearColor=(lastPlacementColor || getPaletteColor(1) || document.documentElement.style.getPropertyValue('--block') || '#6F8FA6').trim();
  coords.forEach(key=>{
    const [cx,cy]=key.split(',').map(Number);
    grid[cy][cx]=EMPTY;
    const cell=document.querySelector(`.cell[data-x="${cx}"][data-y="${cy}"]`);
    if(cell){
      cell.classList.remove('filled');
      cell.classList.remove('preview');
      cell.style.background='';
      cell.style.removeProperty('--cell-fill');
      cell.style.setProperty('--clear-color', clearColor);
      const rowDelay = rowSet.has(cy) ? cx*delayStepSeconds : 0;
      const colDelay = colSet.has(cx) ? cy*delayStepSeconds : 0;
      const delay = Math.max(rowDelay, colDelay);
      cell.style.setProperty('--clear-delay', `${delay}s`);
      cell.classList.add('clearing');
      pendingAnimations++;
      const handle=()=>{
        cell.classList.remove('clearing');
        cell.style.removeProperty('--clear-delay');
        cell.style.removeProperty('--clear-color');
        if(--pendingAnimations===0) finishClear();
      };
      cell.addEventListener('animationend', handle, {once:true});
    }
  });

  score += (rows.length+cols.length)*10;
  scoreEl.textContent=score;
  if(pendingAnimations===0) finishClear();
}

function previewHover(e){
  showPreviewAt(+e.currentTarget.dataset.x, +e.currentTarget.dataset.y);
}

function showPreviewAt(x,y){
  if(!selected) return;
  const origin=findPlacementOrigin(x,y);
  if(!origin) return;
  currentPreview={origin, cells:[]};
}

function clearPreviewAll(){
  if(currentPreview && currentPreview.cells){
    currentPreview.cells.forEach(cell=>cell.classList.remove('preview'));
  }else{
    document.querySelectorAll('.cell.preview').forEach(c=>c.classList.remove('preview'));
  }
  currentPreview=null;
}

function handleDragOver(e){
  if(!selected) return;
  e.preventDefault();
  if(e.dataTransfer) e.dataTransfer.dropEffect='move';
  const cell=e.currentTarget;
  showPreviewAt(+cell.dataset.x, +cell.dataset.y);
}

function handleDrop(e){
  if(!selected) return;
  e.preventDefault();
  e.stopPropagation();
  const cell=e.currentTarget;
  attemptPlacement(+cell.dataset.x, +cell.dataset.y);
}

boardEl.addEventListener('dragover', handleBoardDragOver);
boardEl.addEventListener('drop', handleBoardDrop);
boardEl.addEventListener('pointerleave', ()=>{ if(!draggingPiece) clearPreviewAll(); });

function handleBoardDragOver(e){
  if(!selected) return;
  e.preventDefault();
  if(e.dataTransfer) e.dataTransfer.dropEffect='move';
  const cell=e.target.closest('.cell');
  if(cell) showPreviewAt(+cell.dataset.x, +cell.dataset.y);
}

function handleBoardDrop(e){
  if(!selected) return;
  e.preventDefault();
  if(currentPreview && currentPreview.origin){
    attemptPlacement(null,null,currentPreview.origin);
  }else{
    const cell=e.target.closest('.cell');
    if(cell) attemptPlacement(+cell.dataset.x, +cell.dataset.y);
  }
}

function attemptPlacement(x,y,originOverride=null){
  if(!selected) return false;
  if(isClearing){ bumpBoard(); return false; }
  const piece=selected.shape;
  const idx=selected.idx;
  let origin=originOverride;
  if(!origin && Number.isFinite(x) && Number.isFinite(y)){
    origin=findPlacementOrigin(x,y);
  }
  if(!origin && currentPreview) origin=currentPreview.origin;
  if(!origin){
    bumpBoard();
    return false;
  }
  const {ox,oy}=origin;
  placeAt(ox,oy,piece, selected && Number.isFinite(selected.tone) ? selected.tone : null);
  if(typeof idx==='number' && tray[idx]){
    tray[idx]=null;
  }
  selected=null;
  clearPreviewAll();
  if(tray.every(slot=>!slot)){
    refillTray();
  }else{
    renderTray();
  }
  saveGameState();
  checkGameOver();
  return true;
}

function bumpBoard(){
  /* no-op to keep board steady */
}

function checkGameOver(){
  const activePieces=tray.filter(Boolean);
  if(!activePieces.length) return;
  const anyFit = activePieces.some(p=>{
    for(let y=0;y<BOARD;y++){
      for(let x=0;x<BOARD;x++){
        if(canPlaceAt(x,y,p.shape)) return true;
      }
    }
    return false;
  });
  if(!anyFit){
    updateBestScoreDisplay();
    gameOverEl.classList.add('show');
    document.body.classList.add('game-over-active');
    freezeTopbar();
    clearSavedGame();
  }
}

/* controls */
document.getElementById('resetBtn').onclick=()=>start(true);
document.getElementById('againBtn').onclick=()=>{ hideGameOver(); start(true); };
if(paletteBtn){
  paletteBtn.addEventListener('click', e=>{
    e.preventDefault();
    e.stopPropagation();
    openMenuLayer('palette');
  });
}
if(settingsBtn){
  settingsBtn.addEventListener('click', e=>{
    e.preventDefault();
    e.stopPropagation();
    openMenuLayer('settings');
  });
}
if(soundToggle){
  soundToggle.addEventListener('click', ()=>{
    soundEnabled=!soundEnabled;
    updateSoundToggle();
    try{ localStorage.setItem(STORAGE_KEYS.sound, String(soundEnabled)); }catch(err){}
  });
}
if(themeButtons.length){
  themeButtons.forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const mode=btn.dataset.themeMode || THEME_MODES.AUTO;
      applyTheme(mode,true);
    });
  });
}

/* boot */
function start(forceNew=false){
  hideGameOver();
  selected=null;
  isClearing=false;
  clearPreviewAll();
  boardEl.classList.remove('dragging');
  tray=new Array(3).fill(null);
  buildBoard();
  clearPendingAnchor();
  if(forceNew){
    clearSavedGame();
    score=0;
    scoreEl.textContent=score;
    newGrid();
    refillTray(true);
  }else{
    const restored=restoreSavedGame();
    if(!restored){
      score=0;
      scoreEl.textContent=score;
      newGrid();
      refillTray(true);
    }
  }
  scheduleResponsiveSize();
}
start();

window.addEventListener('resize', scheduleResponsiveSize);
window.addEventListener('orientationchange', scheduleResponsiveSize);

let lastTouchTime=0;
let touchSequence=[];
document.addEventListener('touchend', e=>{
  const now=Date.now();
  if(now-lastTouchTime<350){
    e.preventDefault();
  }
  touchSequence=touchSequence.filter(ts=>now-ts<1000);
  touchSequence.push(now);
  if(touchSequence.length>=3){
    toggleMinimalTop();
    touchSequence=[];
  }
  lastTouchTime=now;
},{passive:false});

if('serviceWorker' in navigator){
  window.addEventListener('load', ()=>{
    navigator.serviceWorker.register('./sw.js').catch(err=>{
      console.warn('Service worker registration failed', err);
    });
  });
}

/* disable pinch/double-tap zoom to avoid stuck zoom on mobile */
function preventPinchZoom(e){
  if(e.touches && e.touches.length>1){
    e.preventDefault();
  }
}
document.addEventListener('touchstart', preventPinchZoom, {passive:false});
document.addEventListener('touchmove', preventPinchZoom, {passive:false});
['gesturestart','gesturechange','gestureend'].forEach(type=>{
  document.addEventListener(type, e=>e.preventDefault(), {passive:false});
});
</script>
</body>
</html>
