<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<meta name="theme-color" content="#F4F1EB" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="default" />
<link rel="manifest" href="manifest.webmanifest" />
<link rel="apple-touch-icon" sizes="180x180" href="icons/apple-touch-icon.png" />
<link rel="preconnect" href="https://fonts.googleapis.com" />
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
<link href="https://fonts.googleapis.com/css2?family=Major+Mono+Display&family=Sixtyfour&display=swap" rel="stylesheet" />
<title>1010 — Minimal</title>
<style>
  :root{
    --bg:#F4F1EB;
    --board:var(--bg);
    --tile:#FFFFFF;
    --block:#57606A;
    --text:#8A8172;
    --shadow:0 14px 45px rgba(39,36,29,.12);
    --max-width:520px;
    --board-size:520px;
    --cell-radius:8px;
    --pip-radius:6px;
    --grid-gap:4px;
    --tray-slot-height:150px;
    --stack-gap:clamp(18px,5vw,28px);
    --sf-icon-palette:url('data:image/png;base64,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');
    --sf-icon-palette:url('data:image/png;base64,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');
    --sf-icon-crown:url('data:image/png;base64,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');
  }
  @media (max-height: 760px){
    body{ gap:clamp(12px,3vh,18px); padding-top:16px; padding-bottom:16px; }
    .wrap{ gap:clamp(12px,3vh,20px); }
  }
  @media (prefers-color-scheme: dark){
    :root{
      --bg:#050506;
      --board:var(--bg);
      --tile:#0E1012;
      --block:#8B96A3;
      --text:#E0E3EA;
      --shadow:0 18px 40px rgba(0,0,0,.65);
    }
    .palette-panel{
      background:#0E0F10;
      border-color:rgba(255,255,255,.08);
    }
  }

  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent;-webkit-touch-callout:none}
  html,body{height:100%}
  body{
    margin:0;
    background:var(--bg);
    color:var(--text);
    font:500 18px/1.45 "Inter", system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:flex-start;
    gap:var(--stack-gap);
    padding:28px clamp(12px,4vw,24px) 28px;
    min-height:100vh;
    min-height:100dvh;
    user-select:none;
    -webkit-user-select:none;
    touch-action:none;
    -webkit-touch-callout:none;
    overflow:hidden;
    overscroll-behavior:none;
  }
  .wrap,
  .board,
  .tray,
  .piece,
  .piece-inner,
  .topbar{
    user-select:none;
    -webkit-user-select:none;
    touch-action:none;
    -webkit-touch-callout:none;
  }

  .topbar{
    width:min(100%, var(--board-size, 100%));
    max-width:var(--max-width);
    position:relative;
    z-index:30;
    display:flex;
    flex-direction:column;
    align-items:stretch;
    justify-content:flex-start;
    gap:var(--stack-gap);
    letter-spacing:.1px;
    color:var(--text);
  }
  .topbar-row{
    width:100%;
    display:flex;
  }
  .topbar-controls{
    display:grid;
    grid-template-columns:auto 1fr auto;
    align-items:center;
    gap:clamp(12px,4vw,28px);
  }
  .game-title{
    font-family:'Sixtyfour', system-ui, sans-serif;
    text-transform:uppercase;
    letter-spacing:.2em;
    font-size:clamp(22px,6vw,32px);
    text-align:center;
    color:var(--text);
    margin:0;
    display:flex;
    align-items:center;
    justify-content:center;
    line-height:1;
    position:relative;
    top:2px;
  }
  .topbar-scores{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:clamp(16px,5vw,32px);
  }
  .topbar.frozen{
    opacity:0;
    visibility:hidden;
    pointer-events:none;
  }

  .btn{
    background:transparent;
    border:none;
    font-weight:600;
    font-size:clamp(16px,4vw,20px);
    color:var(--text);
    cursor:pointer;
    padding:0;
  }
  .btn:active{opacity:.7}
  .score{
    font-family:'Major Mono Display', 'Space Mono', monospace;
    font-weight:400;
    font-size:clamp(24px,5vw,32px);
    letter-spacing:.08em;
    font-variant-numeric:tabular-nums;
    color:var(--text);
    line-height:1;
  }
  .score-card{
    display:flex;
    align-items:center;
    gap:8px;
    min-height:clamp(32px,9vw,40px);
    flex:1;
  }
  .score-card--best{
    justify-content:flex-start;
    text-align:left;
  }
  .score-card--current{
    justify-content:flex-end;
    text-align:right;
  }
  .score-card--best .score{ text-align:left; }
  .score-card--current .score{ text-align:right; }
  .glass-btn{
    width:clamp(48px,12vw,56px);
    height:clamp(48px,12vw,56px);
    border-radius:18px;
    border:1px solid rgba(255,255,255,.6);
    background:rgba(255,255,255,.35);
    backdrop-filter:blur(20px);
    box-shadow:0 10px 28px rgba(0,0,0,.12);
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    color:var(--text);
    position:relative;
    overflow:hidden;
  }
  .glass-btn::after{
    content:'';
    position:absolute;
    inset:6%;
    border-radius:inherit;
    border:1px solid rgba(255,255,255,.7);
    opacity:.4;
    pointer-events:none;
  }
  .glass-btn svg{
    width:clamp(22px,6vw,26px);
    height:clamp(22px,6vw,26px);
    stroke:currentColor;
  }
  .sf-icon{
    display:inline-flex;
    width:clamp(32px,9vw,40px);
    height:clamp(32px,9vw,40px);
    background-color:currentColor;
    -webkit-mask-repeat:no-repeat;
    -webkit-mask-position:center;
    -webkit-mask-size:contain;
    mask-repeat:no-repeat;
    mask-position:center;
    mask-size:contain;
  }
  .crown-icon{
    -webkit-mask-image:var(--sf-icon-crown);
    mask-image:var(--sf-icon-crown);
    width:clamp(30px,8vw,36px);
    height:clamp(24px,7vw,30px);
  }
  .palette-icon{
    width:clamp(22px,6vw,26px);
    height:clamp(22px,6vw,26px);
    -webkit-mask-image:var(--sf-icon-palette);
    mask-image:var(--sf-icon-palette);
  }

  .wrap{
    width:100%;
    max-width:var(--max-width);
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:clamp(16px,4vw,28px);
  }

  .board{
    width:min(100%, var(--board-size, 100%));
    max-width:var(--max-width);
    aspect-ratio:1/1;
    background:var(--board);
    display:grid;
    grid-template-columns:repeat(10,1fr);
    grid-template-rows:repeat(10,1fr);
    gap:var(--grid-gap);
    padding:clamp(8px,2.4vw,16px);
    border-radius:18px;
    box-shadow:none;
  }
  .board.dragging{
    box-shadow:none;
  }
  .cell{
    position:relative;
    overflow:hidden;
    background:var(--tile);
    border-radius:var(--cell-radius);
    box-shadow:inset 0 1px 0 rgba(255,255,255,.6);
    transition:none;
  }
  .cell.filled{
    background:var(--cell-fill, var(--block));
    box-shadow:none;
  }
  .cell.preview{
    box-shadow:none;
  }
  .cell.clearing{
    animation:clearSentinel .35s ease forwards;
    animation-delay:var(--clear-delay,0s);
  }
  .cell.clearing::after{
    content:'';
    position:absolute;
    inset:0;
    border-radius:inherit;
    background:var(--clear-color, var(--block));
    animation:cascadeClear .35s ease forwards;
    animation-delay:var(--clear-delay,0s);
  }
  @keyframes clearSentinel{
    0%{opacity:1;}
    100%{opacity:1;}
  }
  @keyframes cascadeClear{
    0%{transform:scale(1);opacity:1;}
    100%{transform:translateY(-10px);opacity:0;}
  }
  .tray{
    width:min(100%, var(--board-size, 100%));
    max-width:var(--max-width);
    margin:0 auto;
    display:flex;
    align-items:stretch;
    justify-content:space-between;
    gap:var(--piece-gap, clamp(8px, 2vw, 18px));
    overflow:visible;
  }
  .piece{
    flex:1 1 0;
    min-width:0;
    background:transparent;
    border:none;
    border-radius:16px;
    padding:12px 0;
    cursor:grab;
    box-shadow:none;
    transition:transform .2s ease;
    touch-action:none;
    display:flex;
    align-items:center;
    justify-content:center;
    min-height:var(--tray-slot-height, 150px);
    height:var(--tray-slot-height, 150px);
    overflow:visible;
    position:relative;
  }
  .piece:active{cursor:grabbing}
  .piece.dragging{
    visibility:hidden;
  }
  .piece.empty{
    visibility:hidden;
    pointer-events:none;
  }
  .piece-overlay{
    position:absolute;
    top:50%;
    left:50%;
    transform:translate(-50%, -50%);
    pointer-events:none;
  }
  .drag-ghost,
  .pointer-ghost{
    position:fixed;
    top:0;
    left:0;
    pointer-events:none;
    z-index:1000;
    transform:translate(-9999px,-9999px);
    will-change:transform;
  }
  .drag-ghost{
    z-index:-1;
  }
  .piece-inner{
    display:grid;
    gap:var(--grid-gap);
    justify-items:stretch;
    align-items:stretch;
  }
  .drag-ghost{
    position:fixed;
    top:-9999px;
    left:-9999px;
    pointer-events:none;
    z-index:0;
  }

  .palette-wrap{position:relative; display:flex; align-items:flex-start;}
  .palette-btn{width:clamp(48px,12vw,56px);height:clamp(48px,12vw,56px);border-radius:18px;border:1px solid rgba(255,255,255,.6);background:rgba(255,255,255,.35);backdrop-filter:blur(20px);box-shadow:0 10px 28px rgba(0,0,0,.12);display:flex;align-items:center;justify-content:center;cursor:pointer;color:var(--text);position:relative;overflow:hidden;}
  .palette-btn::after{content:'';position:absolute;inset:6%;border-radius:inherit;border:1px solid rgba(255,255,255,.7);opacity:.4;pointer-events:none;}
  .palette-panel{
    position:absolute;
    top:calc(100% + 12px);
    left:0;
    transform:none;
    display:none;
    flex-direction:column;
    gap:6px;
    background:#fff;
    border-radius:14px;
    padding:12px;
    width:max-content;
    min-width:0;
    max-width:min(90vw, 280px);
    box-shadow:0 18px 40px rgba(0,0,0,.12);
    border:1px solid rgba(0,0,0,.08);
    z-index:60;
  }
  .palette-panel.show{display:flex;}
  .palette-option{
    display:flex;
    align-items:center;
    justify-content:flex-start;
    gap:6px;
    padding:6px 8px;
    border-radius:10px;
    border:none;
    background:transparent;
    cursor:pointer;
  }
  .palette-option:hover{background:rgba(0,0,0,.05);}
  .palette-option.active{background:rgba(0,0,0,.08);}
  .palette-swatch{
    display:flex;
    gap:4px;
    align-items:center;
  }
  .palette-dot{
    width:18px;
    height:18px;
    border-radius:6px;
    border:1px solid rgba(0,0,0,.1);
  }

  .b{
    width:100%;
    height:100%;
    background:var(--block);
    border-radius:var(--pip-radius);
    box-shadow:inset 0 1px 0 rgba(255,255,255,.18);
  }

  /* modal */
  .modal{ position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; padding:0 }
  .modal.show{ display:flex }
  .sheet{ background:#fff; color:var(--text); width:100%; max-width:none; border-radius:0; padding:32px clamp(18px,6vw,48px); text-align:center; box-shadow:0 30px 80px rgba(0,0,0,.22); display:flex; flex-direction:column; align-items:center; min-height:clamp(240px,45vh,420px); gap:clamp(18px,3vw,28px); }
  .sheet h2{ margin:0; font-family:'Sixtyfour', system-ui, sans-serif; font-size:clamp(30px,9vw,40px); letter-spacing:1px; text-transform:uppercase; white-space:nowrap; }
  .final-score-value{
    font-size:clamp(48px,10vw,72px);
    color:var(--text);
    letter-spacing:.08em;
    font-weight:700;
    flex:1;
    display:flex;
    align-items:center;
    justify-content:center;
  }
  .sheet .btn{
    font-family:'Sixtyfour', system-ui, sans-serif;
    font-size:clamp(18px,6vw,22px);
    text-transform:uppercase;
    width:100%;
    padding:14px 0;
    border-radius:18px;
    border:1px solid rgba(255,255,255,.6);
    background:rgba(255,255,255,.35);
    backdrop-filter:blur(18px);
    box-shadow:0 10px 28px rgba(0,0,0,.12);
    margin-top:auto;
  }
</style>
</head>
<body>
  <div class="topbar" id="topbar">
    <div class="topbar-row topbar-controls">
      <div class="palette-wrap">
        <button class="palette-btn" id="paletteBtn" aria-label="Change block colors">
          <span class="sf-icon palette-icon" aria-hidden="true"></span>
        </button>
        <div class="palette-panel" id="palettePanel" aria-label="Color options"></div>
      </div>
      <div class="game-title" role="heading" aria-level="1">1010</div>
      <button class="glass-btn" id="resetBtn" aria-label="Reset game">
        <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
          <path d="M3 4v6h6"></path>
          <path d="M21 20v-6h-6"></path>
          <path d="M5.64 17.66a9 9 0 0 0 12.73 0L21 15"></path>
          <path d="M3 9l2.64-2.66a9 9 0 0 1 12.73 0L21 9"></path>
        </svg>
      </button>
    </div>
    <div class="topbar-row topbar-scores" aria-label="Scoreboard">
      <div class="score-card score-card--best">
        <span class="sf-icon crown-icon" aria-hidden="true"></span>
        <div class="score" id="bestScore">0</div>
      </div>
      <div class="score-card score-card--current">
        <div class="score" id="score">0</div>
      </div>
    </div>
  </div>

  <div class="wrap">
    <div id="board" class="board" aria-label="game board" role="grid"></div>
    <div class="tray" id="tray" aria-label="piece tray"></div>
  </div>

  <div class="modal" id="gameOver">
    <div class="sheet game-over-sheet">
      <h2>Game Over</h2>
      <div class="score final-score-value" id="finalScore">0</div>
      <button class="btn" id="againBtn">Play Again</button>
    </div>
  </div>

<script>
/* ------- Minimal 1010 (drag-and-drop) ------- */
const BOARD=10, EMPTY=0;
const CLEAR_DELAY_STEP_MS=50;
const TRAY_SCALE=0.64;
const MIN_TRAY_CELL=15;
const MIN_TRAY_GAP=3;
const STORAGE_KEYS={palette:'1010-palette', state:'1010-state', best:'1010-best'};
const PALETTES=[
  {id:'slate-mix', name:'Slate — Mix', colors:['#3E4349','#57606A','#9CA3AF'], mode:'mix'},
  {id:'slate-single', name:'Slate — Single', colors:['#57606A'], mode:'single'},
  {id:'blue-mix', name:'Blue — Mix', colors:['#2B3A55','#5E81AC','#BFD7EA'], mode:'mix'},
  {id:'blue-single', name:'Blue — Single', colors:['#5E81AC'], mode:'single'},
  {id:'sage-mix', name:'Sage — Mix', colors:['#495A4E','#7E8F83','#C9D4CA'], mode:'mix'},
  {id:'sage-single', name:'Sage — Single', colors:['#7E8F83'], mode:'single'},
  {id:'sand-mix', name:'Sand — Mix', colors:['#5C5346','#A89885','#D8CFC1'], mode:'mix'},
  {id:'sand-single', name:'Sand — Single', colors:['#A89885'], mode:'single'}
];
let grid, score=0, tray=new Array(3).fill(null), selected=null;
let boardCellSize=0, boardGap=4, isClearing=false;
let pendingAnchor=null, pendingAnchorIdx=null;
let pendingAnchorRect=null;
let currentPreview=null;
let draggingPiece=false;
let resizeScheduled=false;
let currentBoardPixels=0;
let pointerDragId=null;
let pointerCaptureTarget=null;
let dragGhost=null;
let pointerGhost=null;
let pointerAnchorOffset={x:0,y:0};
let palettePanelOpen=false;
let currentPaletteId=PALETTES[0].id;
let bestScore=0;
let lastPlacementColor=null;

const ZERO_ANCHOR=()=>({dx:0,dy:0});

function getCurrentPalette(){
  return PALETTES.find(p=>p.id===currentPaletteId) || PALETTES[0];
}

function pickPieceColor(){
  const palette=getCurrentPalette();
  if(!palette || !Array.isArray(palette.colors) || !palette.colors.length){
    const fallback=getComputedStyle(document.documentElement).getPropertyValue('--block') || '#57606A';
    return fallback.trim();
  }
  if(palette.mode==='single'){
    return palette.colors[0];
  }
  const colors=palette.colors;
  return colors[Math.floor(Math.random()*colors.length)];
}

function assignPieceColor(piece){
  if(!piece) return piece;
  piece.color=pickPieceColor();
  return piece;
}

function cloneShape(shape){
  if(!Array.isArray(shape)) return [];
  return shape.map(point=>Array.isArray(point)?[point[0],point[1]]:[0,0]);
}

function clonePiece(piece){
  if(!piece) return null;
  return {
    shape:cloneShape(piece.shape),
    color:piece.color || pickPieceColor()
  };
}

function saveGameState(){
  if(!grid || !Array.isArray(tray)) return;
  const state={
    score,
    grid:grid.map(row=>row.slice()),
    tray:tray.map(clonePiece)
  };
  try{
    localStorage.setItem(STORAGE_KEYS.state, JSON.stringify(state));
  }catch(err){}
}

function clearSavedGame(){
  try{
    localStorage.removeItem(STORAGE_KEYS.state);
  }catch(err){}
}

function restoreSavedGame(){
  let raw=null;
  try{
    raw=localStorage.getItem(STORAGE_KEYS.state);
  }catch(err){
    raw=null;
  }
  if(!raw) return false;
  let data=null;
  try{
    data=JSON.parse(raw);
  }catch(err){
    data=null;
  }
  if(!data || typeof data.score!=='number' || !Array.isArray(data.grid) || data.grid.length!==BOARD) return false;
  grid=data.grid.map(row=>Array.isArray(row)?row.slice(0,BOARD):Array(BOARD).fill(EMPTY));
  tray=new Array(3).fill(null);
  if(Array.isArray(data.tray)){
    for(let i=0;i<Math.min(3,data.tray.length);i++){
      const piece=data.tray[i];
      if(piece && Array.isArray(piece.shape)){
        tray[i]={shape:cloneShape(piece.shape), color:piece.color || pickPieceColor()};
      }
    }
  }
  score=data.score;
  scoreEl.textContent=score;
  updateBoardCells();
  renderTray();
  return true;
}

function getSelectedAnchor(){
  return (selected && selected.anchor) ? selected.anchor : ZERO_ANCHOR();
}

function buildPlacementOffsets(shape){
  const anchor=getSelectedAnchor();
  const offsets=[];
  const seen=new Set();
  const add=(dx,dy)=>{
    const key=`${dx},${dy}`;
    if(!seen.has(key)){ seen.add(key); offsets.push({dx,dy}); }
  };
  add(anchor.dx, anchor.dy);
  shape.forEach(([dx,dy])=>add(dx,dy));
  return offsets;
}

function findPlacementOrigin(x,y){
  if(!selected || !selected.shape || !Number.isFinite(x) || !Number.isFinite(y)) return null;
  const shape=selected.shape;
  const offsets=buildPlacementOffsets(shape);
  for(const off of offsets){
    const ox=x-off.dx, oy=y-off.dy;
    if(canPlaceAt(ox,oy,shape)) return {ox,oy};
  }
  return null;
}

function computeBoardPixels(){
  const rootStyles=getComputedStyle(document.documentElement);
  const maxWidth=parseFloat(rootStyles.getPropertyValue('--max-width')) || 520;
  const vw=Math.min(window.innerWidth, document.documentElement.clientWidth || window.innerWidth);
  const bodyStyles=getComputedStyle(document.body);
  const horizontalPadding=parseFloat(bodyStyles.paddingLeft)+parseFloat(bodyStyles.paddingRight);
  const verticalPadding=parseFloat(bodyStyles.paddingTop)+parseFloat(bodyStyles.paddingBottom);
  const topbar=document.querySelector('.topbar');
  const wrap=document.querySelector('.wrap');
  const topHeight=topbar?topbar.offsetHeight:0;
  const wrapGap=wrap?parseFloat(getComputedStyle(wrap).gap)||0:0;
  const trayHeight=trayEl?trayEl.offsetHeight:0;
  let availableWidth=Math.min(maxWidth, vw-horizontalPadding);
  availableWidth=Math.max(180, availableWidth);
  let availableHeight=window.innerHeight - (verticalPadding + topHeight + wrapGap + trayHeight + 40);
  if(!Number.isFinite(availableHeight) || availableHeight<=0) availableHeight=availableWidth;
  let size=Math.min(availableWidth, availableHeight);
  return Math.max(180, size);
}

function applyBoardSize(){
  const size=computeBoardPixels();
  if(Math.abs(size-currentBoardPixels)<=1) return;
  currentBoardPixels=size;
  document.documentElement.style.setProperty('--board-size', size+'px');
  window.requestAnimationFrame(()=>{ recomputeBoardMetrics(); });
}

function scheduleResponsiveSize(){
  if(resizeScheduled) return;
  resizeScheduled=true;
  window.requestAnimationFrame(()=>{
    resizeScheduled=false;
    applyBoardSize();
    setTimeout(applyBoardSize, 80);
  });
}

function recomputeBoardMetrics(){
  const someCell=boardEl.firstElementChild;
  if(!someCell) return;
  const newSize=Math.round(someCell.getBoundingClientRect().width);
  if(!newSize || newSize===boardCellSize) return;
  boardCellSize=newSize;
  const rootStyles=getComputedStyle(document.documentElement);
  const baseGap=parseFloat(rootStyles.getPropertyValue('--grid-gap')) || 4;
  boardGap=baseGap;
  if(trayEl){
    const trayGap=Math.max(8, baseGap*2);
    trayEl.style.setProperty('--piece-gap', trayGap+'px');
  }
  const baseRadius=parseFloat(rootStyles.getPropertyValue('--cell-radius')) || 8;
  document.documentElement.style.setProperty('--cell-radius', baseRadius+'px');
  document.documentElement.style.setProperty('--pip-radius', Math.max(0, baseRadius-2)+'px');
  const slotHeight=Math.max(130, Math.min(240, boardCellSize*3));
  document.documentElement.style.setProperty('--tray-slot-height', slotHeight+'px');
  renderTray();
}

const SHAPES=[
  [[0,0]],
  [[0,0],[1,0]], [[0,0],[0,1]],
  [[0,0],[1,0],[2,0]], [[0,0],[0,1],[0,2]],
  [[0,0],[1,0],[2,0],[3,0]], [[0,0],[0,1],[0,2],[0,3]],
  [[0,0],[1,0],[2,0],[3,0],[4,0]], [[0,0],[0,1],[0,2],[0,3],[0,4]],
  [[0,0],[1,0],[0,1],[1,1]],
  [[0,0],[1,0],[2,0],[0,1],[1,1],[2,1],[0,2],[1,2],[2,2]],
  [[0,0],[0,1],[0,2],[1,2]],
  [[0,0],[1,0],[2,0],[1,1]],
  [[0,0],[1,0],[1,1],[2,1]],
  [[0,0],[0,1],[1,1],[1,2]],
  [[0,0],[0,1],[1,1]],
  [[0,0],[1,0],[2,0],[2,1]],
];

const topbarEl=document.getElementById('topbar');
const boardEl=document.getElementById('board');
const trayEl=document.getElementById('tray');
const scoreEl=document.getElementById('score');
const gameOverEl=document.getElementById('gameOver');
const finalScoreEl=document.getElementById('finalScore');
const bestScoreEl=document.getElementById('bestScore');
const paletteBtn=document.getElementById('paletteBtn');
const palettePanel=document.getElementById('palettePanel');

function buildPalettePanel(){
  if(!palettePanel) return;
  palettePanel.innerHTML='';
  PALETTES.forEach(palette=>{
    const btn=document.createElement('button');
    btn.className='palette-option';
    btn.dataset.palette=palette.id;
    btn.type='button';
    btn.title=palette.name;
    btn.setAttribute('aria-label', palette.name);
    const swatch=document.createElement('div');
    swatch.className='palette-swatch';
    palette.colors.forEach(color=>{
      const dot=document.createElement('span');
      dot.className='palette-dot';
      dot.style.background=color;
      swatch.appendChild(dot);
    });
    btn.appendChild(swatch);
    btn.addEventListener('click',()=>{
      applyPalette(palette.id,true);
      closePalettePanel();
    });
    palettePanel.appendChild(btn);
  });
  updatePaletteSelection();
}

function updatePaletteSelection(){
  if(!palettePanel) return;
  palettePanel.querySelectorAll('.palette-option').forEach(btn=>{
    btn.classList.toggle('active', btn.dataset.palette===currentPaletteId);
  });
}

function applyPalette(id, persist=false){
  const palette=PALETTES.find(p=>p.id===id) || PALETTES[0];
  currentPaletteId=palette.id;
  document.documentElement.style.setProperty('--block', palette.colors[0]);
  if(persist){
    try{ localStorage.setItem(STORAGE_KEYS.palette,currentPaletteId); }catch(err){}
  }
  tray=tray.map(piece=>piece?assignPieceColor(piece):piece);
  if(selected && typeof selected.idx==='number' && tray[selected.idx]){
    selected.color=tray[selected.idx].color;
  }
  updatePaletteSelection();
  updateBoardCells();
  renderTray();
}

function togglePalettePanel(){
  palettePanelOpen=!palettePanelOpen;
  if(palettePanel){
    palettePanel.classList.toggle('show', palettePanelOpen);
  }
}

function closePalettePanel(){
  palettePanelOpen=false;
  if(palettePanel){
    palettePanel.classList.remove('show');
  }
}

function loadSavedPalette(){
  let saved=null;
  try{
    saved=localStorage.getItem(STORAGE_KEYS.palette);
  }catch(err){
    saved=null;
  }
  applyPalette(saved || currentPaletteId, false);
}

function loadBestScore(){
  let saved=null;
  try{
    saved=localStorage.getItem(STORAGE_KEYS.best);
  }catch(err){
    saved=null;
  }
  const parsed=parseInt(saved,10);
  bestScore=Number.isFinite(parsed) && parsed>0 ? parsed : 0;
  updateBestScoreDisplay();
}

function updateBestScoreDisplay(){
  if(bestScoreEl) bestScoreEl.textContent=bestScore;
}

function freezeTopbar(){
  if(topbarEl) topbarEl.classList.add('frozen');
}
function unfreezeTopbar(){
  if(topbarEl) topbarEl.classList.remove('frozen');
}

function recordBestScore(){
  if(score>bestScore){
    bestScore=score;
    updateBestScoreDisplay();
    try{ localStorage.setItem(STORAGE_KEYS.best,String(bestScore)); }catch(err){}
  }
}

function hideGameOver(){
  if(gameOverEl) gameOverEl.classList.remove('show');
  unfreezeTopbar();
}

buildPalettePanel();
loadSavedPalette();
loadBestScore();

function buildBoard(){
  boardEl.innerHTML='';
  for(let i=0;i<BOARD*BOARD;i++){
    const d=document.createElement('div');
    d.className='cell';
    d.dataset.x=(i%BOARD);
    d.dataset.y=Math.floor(i/BOARD);
    d.addEventListener('pointerenter', previewHover);
    d.addEventListener('pointerleave', ()=>{ if(selected && !draggingPiece) clearPreviewAll(); });
    d.addEventListener('dragover', handleDragOver);
    d.addEventListener('drop', handleDrop);
    boardEl.appendChild(d);
  }
  const someCell=boardEl.firstElementChild;
  boardCellSize=Math.round(someCell.getBoundingClientRect().width);
}

function newGrid(){ grid=Array.from({length:BOARD},()=>Array(BOARD).fill(EMPTY)); updateBoardCells(); }
function dealPiece(){
  return assignPieceColor({shape: JSON.parse(JSON.stringify(SHAPES[Math.floor(Math.random()*SHAPES.length)]))});
}
function refillTray(force=false){
  if(!Array.isArray(tray) || tray.length!==3){
    tray=new Array(3).fill(null);
  }
  const needsRefill = force || tray.every(slot=>!slot);
  if(needsRefill){
    for(let i=0;i<tray.length;i++){
      tray[i]=dealPiece();
    }
  }
  selected=null;
  clearPreviewAll();
  clearPendingAnchor();
  renderTray();
  saveGameState();
}

function drawPiece(container,shape,{fullSize=false,color=null,skipSizing=false}={}){
  container.innerHTML='';
  const xs=shape.map(s=>s[0]), ys=shape.map(s=>s[1]);
  const w=Math.max(...xs)+1, h=Math.max(...ys)+1;
  const baseCell=boardCellSize || 32;
  const baseGap=boardGap || 6;
  const miniCell=Math.max(MIN_TRAY_CELL, Math.round(baseCell*TRAY_SCALE));
  const miniGap=Math.max(MIN_TRAY_GAP, Math.round(baseGap*TRAY_SCALE));
  const cellSize=fullSize ? baseCell : miniCell;
  const gap=fullSize ? baseGap : miniGap;
  const fillColor=(color || document.documentElement.style.getPropertyValue('--block') || getComputedStyle(document.documentElement).getPropertyValue('--block') || '#57606A').trim();
  const width=(w*cellSize)+Math.max(0,w-1)*gap;
  const height=(h*cellSize)+Math.max(0,h-1)*gap;
  container.style.display='grid';
  container.style.width=width+'px';
  container.style.height=height+'px';
  container.style.gridTemplateColumns=`repeat(${w}, ${cellSize}px)`;
  container.style.gridTemplateRows=`repeat(${h}, ${cellSize}px)`;
  container.style.gap=gap+'px';
  const parentEl=container.parentElement;
  if(parentEl && parentEl!==document.body && !skipSizing){
    parentEl.style.minHeight=(height+20)+'px';
  }
  shape.forEach(([x,y])=>{
    const b=document.createElement('div'); b.className='b';
    b.dataset.cx=x;
    b.dataset.cy=y;
    b.style.gridColumn=(x+1);
    b.style.gridRow=(y+1);
    b.style.background=fillColor;
    container.appendChild(b);
  });
}

function createDragGhost(shape,color){
  const ghost=document.createElement('div');
  ghost.className='drag-ghost';
  ghost.style.padding='0';
  ghost.style.margin='0';
  ghost.style.background='transparent';
  document.body.appendChild(ghost);
  drawPiece(ghost,shape,{fullSize:true,color});
  return ghost;
}

function createPointerGhost(shape,color){
  removePointerGhost();
  pointerGhost=document.createElement('div');
  pointerGhost.className='pointer-ghost';
  document.body.appendChild(pointerGhost);
  drawPiece(pointerGhost,shape,{fullSize:true,color});
  return pointerGhost;
}

function getAnchorCenterOffsetPx(){
  const anchor=getSelectedAnchor();
  const cell=boardCellSize || 32;
  const gap=boardGap || 6;
  return {
    x:(anchor.dx||0)*(cell+gap) + cell/2,
    y:(anchor.dy||0)*(cell+gap) + cell/2
  };
}

function updatePointerGhostPosition(e){
  if(!pointerGhost) return;
  const anchorPoint=getAnchorPointFromEvent(e);
  const offset=getAnchorCenterOffsetPx();
  const left=anchorPoint.x - offset.x;
  const top=anchorPoint.y - offset.y;
  pointerGhost.style.transform=`translate(${left}px, ${top}px)`;
}

function removePointerGhost(){
  if(pointerGhost){
    pointerGhost.remove();
    pointerGhost=null;
  }
}

function renderTray(){
  trayEl.innerHTML='';
  tray.forEach((p,idx)=>{
    const card=document.createElement('div');
    const hasPiece=!!p;
    const isActive=hasPiece && selected && selected.idx===idx;
    const isDraggingActive=isActive && draggingPiece;
    card.className='piece'+(isActive?' selected':'')+(isDraggingActive?' dragging':'')+(hasPiece?'':' empty');
    if(hasPiece){
      card.setAttribute('draggable','true');
      card.addEventListener('pointerdown', e=>handlePiecePointerDown(e,idx));
      card.addEventListener('dragstart', e=>beginDrag(e,idx));
      card.addEventListener('dragend', finishDrag);
      const inner=document.createElement('div'); inner.className='piece-inner'; card.appendChild(inner);
      drawPiece(inner,p.shape,{fullSize:false,color:p.color});
      if(isActive && !draggingPiece){
        const overlay=document.createElement('div');
        overlay.className='piece-overlay';
        card.appendChild(overlay);
        drawPiece(overlay,p.shape,{fullSize:true,color:p.color, skipSizing:true});
      }
    }else{
      card.setAttribute('aria-hidden','true');
    }
    trayEl.appendChild(card);
  });
}

function handlePiecePointerDown(e,idx){
  if(!tray[idx]) return;
  rememberAnchor(e,idx);
  capturePointerAnchorOffset(e);
  if(e.pointerType==='mouse' || e.pointerType==='pen'){
    return;
  }
  if(isClearing || draggingPiece) return;
  e.preventDefault();
  startPointerDrag(e,idx);
}

function startPointerDrag(e,idx){
  const piece=tray[idx];
  if(!piece) return;
  const anchor = takeAnchorFromDrag(e,idx);
  selected={shape:piece.shape, idx, anchor, color:piece.color};
  setTimeout(()=>renderTray(),0);
  draggingPiece=true;
  pointerDragId=e.pointerId;
  pointerCaptureTarget=e.currentTarget;
  if(pointerCaptureTarget && pointerCaptureTarget.setPointerCapture){
    try{ pointerCaptureTarget.setPointerCapture(e.pointerId); }catch(err){}
  }
  pointerGhost=createPointerGhost(piece.shape,piece.color);
  boardEl.classList.add('dragging');
  window.addEventListener('pointermove', handlePointerMove);
  window.addEventListener('pointerup', handlePointerUp);
  window.addEventListener('pointercancel', handlePointerCancel);
  updatePointerPreview(e);
  updatePointerGhostPosition(e);
}

function handlePointerMove(e){
  if(e.pointerId!==pointerDragId) return;
  e.preventDefault();
  updatePointerPreview(e);
  updatePointerGhostPosition(e);
}

function handlePointerUp(e){
  if(e.pointerId!==pointerDragId) return;
  e.preventDefault();
  finalizePointerDrag(e);
}

function handlePointerCancel(e){
  if(e.pointerId!==pointerDragId) return;
  e.preventDefault();
  cancelPointerDrag();
}

function updatePointerPreview(e){
  const anchorPoint=getAnchorPointFromEvent(e);
  const cell=getCellFromCoords(anchorPoint.x, anchorPoint.y);
  if(cell){
    showPreviewAt(+cell.dataset.x, +cell.dataset.y);
  }else{
    clearPreviewAll();
  }
}

function finalizePointerDrag(e){
  cleanupPointerDragListeners();
  pointerDragId=null;
  const anchorPoint=getAnchorPointFromEvent(e);
  const cell=getCellFromCoords(anchorPoint.x, anchorPoint.y);
  let placed=false;
  if(cell){
    placed=attemptPlacement(+cell.dataset.x, +cell.dataset.y);
  }else if(currentPreview && currentPreview.origin){
    placed=attemptPlacement(null,null,currentPreview.origin);
  }
  if(!placed){
    finishDrag();
  }else{
    releaseDragUIState();
  }
}

function cancelPointerDrag(){
  cleanupPointerDragListeners();
  pointerDragId=null;
  finishDrag();
}

function cleanupPointerDragListeners(){
  window.removeEventListener('pointermove', handlePointerMove);
  window.removeEventListener('pointerup', handlePointerUp);
  window.removeEventListener('pointercancel', handlePointerCancel);
  releasePointerCapture();
}

function releasePointerCapture(){
  if(pointerCaptureTarget && pointerCaptureTarget.releasePointerCapture && pointerDragId!=null){
    try{ pointerCaptureTarget.releasePointerCapture(pointerDragId); }catch(err){}
  }
  pointerCaptureTarget=null;
}

function rememberAnchor(e,idx){
  const tile=e.target.closest('.b');
  if(tile){
    pendingAnchor={dx:+tile.dataset.cx, dy:+tile.dataset.cy};
    pendingAnchorIdx=idx;
    pendingAnchorRect=tile.getBoundingClientRect();
  }else{
    clearPendingAnchor();
  }
}

function clearPendingAnchor(){
  pendingAnchor=null;
  pendingAnchorIdx=null;
  pendingAnchorRect=null;
}

function takeAnchorFromDrag(e,idx){
  const pending = (pendingAnchorIdx===idx && pendingAnchor) ? pendingAnchor : null;
  clearPendingAnchor();
  const fromPoint = anchorFromPointer(e);
  return pending || fromPoint || ZERO_ANCHOR();
}

function anchorFromPointer(e){
  if(typeof e.clientX!=='number' || typeof e.clientY!=='number') return null;
  const el=document.elementFromPoint(e.clientX, e.clientY);
  const tile=el && el.closest('.b');
  if(tile && tile.dataset.cx!=null){
    return {dx:+tile.dataset.cx, dy:+tile.dataset.cy};
  }
  return null;
}

function capturePointerAnchorOffset(e){
  if(e && pendingAnchorRect){
    const cx=typeof e.clientX==='number' ? e.clientX : 0;
    const cy=typeof e.clientY==='number' ? e.clientY : 0;
    const centerX=pendingAnchorRect.left + pendingAnchorRect.width/2;
    const centerY=pendingAnchorRect.top + pendingAnchorRect.height/2;
    pointerAnchorOffset={
      x:cx-centerX,
      y:cy-centerY
    };
  }else{
    pointerAnchorOffset={x:0,y:0};
  }
}

function getAnchorPointFromEvent(e){
  const baseX=typeof e.clientX==='number' ? e.clientX : 0;
  const baseY=typeof e.clientY==='number' ? e.clientY : 0;
  const cell=boardCellSize || 32;
  const gap=boardGap || 6;
  const lift=Math.max((cell+gap)*2, 48);
  return {
    x:baseX - pointerAnchorOffset.x,
    y:baseY - pointerAnchorOffset.y - lift
  };
}

function getCellFromCoords(x,y){
  if(!Number.isFinite(x) || !Number.isFinite(y)) return null;
  const clampedX=Math.max(0, Math.min(window.innerWidth-1, x));
  const clampedY=Math.max(0, Math.min(window.innerHeight-1, y));
  const el=document.elementFromPoint(clampedX, clampedY);
  return el && el.closest('.cell');
}

function beginDrag(e,idx){
  if(isClearing){ e.preventDefault(); return; }
  const piece=tray[idx];
  if(!piece) return;
  const anchor = takeAnchorFromDrag(e,idx);
  selected={shape:piece.shape, idx, anchor, color:piece.color};
  dragGhost=createDragGhost(piece.shape,piece.color);
  setTimeout(()=>renderTray(),0);
  draggingPiece=true;
  boardEl.classList.add('dragging');
  if(e.dataTransfer){
    if(dragGhost){
      const rect=dragGhost.getBoundingClientRect();
      e.dataTransfer.setDragImage(dragGhost, rect.width/2, rect.height/2);
    }
    e.dataTransfer.effectAllowed='move';
    e.dataTransfer.setData('text/plain', String(idx));
  }
}

function finishDrag(){
  releaseDragUIState();
  clearPreviewAll();
  selected=null;
  renderTray();
}

function releaseDragUIState(){
  boardEl.classList.remove('dragging');
  draggingPiece=false;
  releasePointerCapture();
  removePointerGhost();
  pointerAnchorOffset={x:0,y:0};
  if(dragGhost){
    dragGhost.remove();
    dragGhost=null;
  }
}

function updateBoardCells(){
  if(!grid) return;
  document.querySelectorAll('.cell').forEach(c=>{
    const x=+c.dataset.x, y=+c.dataset.y;
    const cellValue=grid[y][x];
    const isFilled = cellValue!==EMPTY;
    c.classList.toggle('filled', isFilled);
    c.classList.remove('preview');
    if(isFilled){
      c.style.setProperty('--cell-fill', cellValue);
      c.style.background=cellValue;
      c.style.boxShadow='none';
    }else{
      c.style.removeProperty('--cell-fill');
      c.style.background='';
      c.style.boxShadow='';
    }
  });
}

function canPlaceAt(x,y,shape){
  return shape.every(([dx,dy])=>{
    const cx=x+dx, cy=y+dy;
    return cx>=0 && cy>=0 && cx<BOARD && cy<BOARD && grid[cy][cx]===EMPTY;
  });
}

function placeAt(x,y,shape,color=null){
  const fillColor=color || pickPieceColor();
  lastPlacementColor=fillColor;
  shape.forEach(([dx,dy])=>{ grid[y+dy][x+dx]=fillColor; });
  score += shape.length; scoreEl.textContent=score;
  recordBestScore();
  updateBoardCells();
  clearLines();
}

function clearLines(){
  const rows=[], cols=[];
  for(let y=0;y<BOARD;y++) if(grid[y].every(v=>v!==EMPTY)) rows.push(y);
  for(let x=0;x<BOARD;x++){
    let ok=true;
    for(let y=0;y<BOARD;y++) if(grid[y][x]===EMPTY){ ok=false; break; }
    if(ok) cols.push(x);
  }
  if(!rows.length && !cols.length) return;

  isClearing=true;
  const coords=new Set();
  const rowSet=new Set(rows);
  const colSet=new Set(cols);
  const delayStepSeconds=CLEAR_DELAY_STEP_MS/1000;
  let pendingAnimations=0;
  let resolved=false;
  const finishClear=()=>{
    if(resolved) return;
    resolved=true;
    isClearing=false;
  };
  rows.forEach(y=>{ for(let x=0;x<BOARD;x++) coords.add(`${x},${y}`); });
  cols.forEach(x=>{ for(let y=0;y<BOARD;y++) coords.add(`${x},${y}`); });

  const clearColor=(lastPlacementColor || getComputedStyle(document.documentElement).getPropertyValue('--block') || '#57606A').trim();
  coords.forEach(key=>{
    const [cx,cy]=key.split(',').map(Number);
    grid[cy][cx]=EMPTY;
    const cell=document.querySelector(`.cell[data-x="${cx}"][data-y="${cy}"]`);
    if(cell){
      cell.classList.remove('filled');
      cell.classList.remove('preview');
      cell.style.background='';
      cell.style.removeProperty('--cell-fill');
      cell.style.setProperty('--clear-color', clearColor);
      const rowDelay = rowSet.has(cy) ? cx*delayStepSeconds : 0;
      const colDelay = colSet.has(cx) ? cy*delayStepSeconds : 0;
      const delay = Math.max(rowDelay, colDelay);
      cell.style.setProperty('--clear-delay', `${delay}s`);
      cell.classList.add('clearing');
      pendingAnimations++;
      const handle=()=>{
        cell.classList.remove('clearing');
        cell.style.removeProperty('--clear-delay');
        cell.style.removeProperty('--clear-color');
        if(--pendingAnimations===0) finishClear();
      };
      cell.addEventListener('animationend', handle, {once:true});
    }
  });

  score += (rows.length+cols.length)*10;
  scoreEl.textContent=score;
  if(pendingAnimations===0) finishClear();
}

function previewHover(e){
  showPreviewAt(+e.currentTarget.dataset.x, +e.currentTarget.dataset.y);
}

function showPreviewAt(x,y){
  if(!selected) return;
  const origin=findPlacementOrigin(x,y);
  clearPreviewAll();
  if(!origin) return;
  const {ox,oy}=origin;
  const shape=selected.shape;
  const cells=[];
  shape.forEach(([dx,dy])=>{
    const cell=document.querySelector(`.cell[data-x="${ox+dx}"][data-y="${oy+dy}"]`);
    if(cell){
      cell.classList.add('preview');
      cells.push(cell);
    }
  });
  currentPreview={origin, cells};
}

function clearPreviewAll(){
  if(currentPreview && currentPreview.cells){
    currentPreview.cells.forEach(cell=>cell.classList.remove('preview'));
  }else{
    document.querySelectorAll('.cell.preview').forEach(c=>c.classList.remove('preview'));
  }
  currentPreview=null;
}

function handleDragOver(e){
  if(!selected) return;
  e.preventDefault();
  if(e.dataTransfer) e.dataTransfer.dropEffect='move';
  const cell=e.currentTarget;
  showPreviewAt(+cell.dataset.x, +cell.dataset.y);
}

function handleDrop(e){
  if(!selected) return;
  e.preventDefault();
  e.stopPropagation();
  const cell=e.currentTarget;
  attemptPlacement(+cell.dataset.x, +cell.dataset.y);
}

boardEl.addEventListener('dragover', handleBoardDragOver);
boardEl.addEventListener('drop', handleBoardDrop);
boardEl.addEventListener('pointerleave', ()=>{ if(!draggingPiece) clearPreviewAll(); });

function handleBoardDragOver(e){
  if(!selected) return;
  e.preventDefault();
  if(e.dataTransfer) e.dataTransfer.dropEffect='move';
  const cell=e.target.closest('.cell');
  if(cell) showPreviewAt(+cell.dataset.x, +cell.dataset.y);
}

function handleBoardDrop(e){
  if(!selected) return;
  e.preventDefault();
  if(currentPreview && currentPreview.origin){
    attemptPlacement(null,null,currentPreview.origin);
  }else{
    const cell=e.target.closest('.cell');
    if(cell) attemptPlacement(+cell.dataset.x, +cell.dataset.y);
  }
}

function attemptPlacement(x,y,originOverride=null){
  if(!selected) return false;
  if(isClearing){ bumpBoard(); return false; }
  const piece=selected.shape;
  const idx=selected.idx;
  let origin=originOverride;
  if(!origin && Number.isFinite(x) && Number.isFinite(y)){
    origin=findPlacementOrigin(x,y);
  }
  if(!origin && currentPreview) origin=currentPreview.origin;
  if(!origin){
    bumpBoard();
    return false;
  }
  const {ox,oy}=origin;
  placeAt(ox,oy,piece, selected && selected.color ? selected.color : null);
  if(typeof idx==='number' && tray[idx]){
    tray[idx]=null;
  }
  selected=null;
  clearPreviewAll();
  if(tray.every(slot=>!slot)){
    refillTray();
  }else{
    renderTray();
  }
  saveGameState();
  checkGameOver();
  return true;
}

function bumpBoard(){
  /* no-op to keep board steady */
}

function checkGameOver(){
  const activePieces=tray.filter(Boolean);
  if(!activePieces.length) return;
  const anyFit = activePieces.some(p=>{
    for(let y=0;y<BOARD;y++){
      for(let x=0;x<BOARD;x++){
        if(canPlaceAt(x,y,p.shape)) return true;
      }
    }
    return false;
  });
  if(!anyFit){
    finalScoreEl.textContent=score;
    updateBestScoreDisplay();
    gameOverEl.classList.add('show');
    freezeTopbar();
    clearSavedGame();
  }
}

/* controls */
document.getElementById('resetBtn').onclick=()=>start(true);
document.getElementById('againBtn').onclick=()=>{ hideGameOver(); start(true); };
if(paletteBtn){
  paletteBtn.addEventListener('click', e=>{
    e.stopPropagation();
    togglePalettePanel();
  });
}
document.addEventListener('click', e=>{
  if(!palettePanelOpen) return;
  const target=e.target;
  if(palettePanel && !palettePanel.contains(target) && target!==paletteBtn && (!paletteBtn || !paletteBtn.contains(target))){
    closePalettePanel();
  }
});
window.addEventListener('keydown', e=>{
  if(e.key==='Escape'){
    closePalettePanel();
  }
});

/* boot */
function start(forceNew=false){
  closePalettePanel();
  hideGameOver();
  selected=null;
  isClearing=false;
  clearPreviewAll();
  boardEl.classList.remove('dragging');
  tray=new Array(3).fill(null);
  buildBoard();
  clearPendingAnchor();
  if(forceNew){
    clearSavedGame();
    score=0;
    scoreEl.textContent=score;
    newGrid();
    refillTray(true);
  }else{
    const restored=restoreSavedGame();
    if(!restored){
      score=0;
      scoreEl.textContent=score;
      newGrid();
      refillTray(true);
    }
  }
  scheduleResponsiveSize();
}
start();

window.addEventListener('resize', scheduleResponsiveSize);
window.addEventListener('orientationchange', scheduleResponsiveSize);

if('serviceWorker' in navigator){
  window.addEventListener('load', ()=>{
    navigator.serviceWorker.register('./sw.js').catch(err=>{
      console.warn('Service worker registration failed', err);
    });
  });
}
</script>
</body>
</html>
